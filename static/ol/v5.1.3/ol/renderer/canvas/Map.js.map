{"version":3,"file":"Map.js","sources":["../../../../src/ol/renderer/canvas/Map.js"],"sourcesContent":["/**\r\n * @module ol/renderer/canvas/Map\r\n */\r\nimport {create as createTransform, apply as applyTransform, compose as composeTransform} from '../../transform.js';\r\nimport {includes, stableSort} from '../../array.js';\r\nimport {CLASS_UNSELECTABLE} from '../../css.js';\r\nimport {createCanvasContext2D} from '../../dom.js';\r\nimport {visibleAtResolution} from '../../layer/Layer.js';\r\nimport RenderEvent from '../../render/Event.js';\r\nimport RenderEventType from '../../render/EventType.js';\r\nimport {rotateAtOffset} from '../../render/canvas.js';\r\nimport CanvasImmediateRenderer from '../../render/canvas/Immediate.js';\r\nimport MapRenderer, {sortByZIndex} from '../Map.js';\r\nimport SourceState from '../../source/State.js';\r\n\r\n\r\n/**\r\n * @type {Array.<module:ol/renderer/Layer>}\r\n */\r\nexport const layerRendererConstructors = [];\r\n\r\n/**\r\n * @classdesc\r\n * Canvas map renderer.\r\n * @api\r\n */\r\nclass CanvasMapRenderer extends MapRenderer {\r\n\r\n  /**\r\n   * @param {module:ol/PluggableMap} map Map.\r\n   */\r\n  constructor(map) {\r\n    super(map);\r\n\r\n    const container = map.getViewport();\r\n\r\n    /**\r\n     * @private\r\n     * @type {CanvasRenderingContext2D}\r\n     */\r\n    this.context_ = createCanvasContext2D();\r\n\r\n    /**\r\n     * @private\r\n     * @type {HTMLCanvasElement}\r\n     */\r\n    this.canvas_ = this.context_.canvas;\r\n\r\n    this.canvas_.style.width = '100%';\r\n    this.canvas_.style.height = '100%';\r\n    this.canvas_.style.display = 'block';\r\n    this.canvas_.className = CLASS_UNSELECTABLE;\r\n    container.insertBefore(this.canvas_, container.childNodes[0] || null);\r\n\r\n    /**\r\n     * @private\r\n     * @type {boolean}\r\n     */\r\n    this.renderedVisible_ = true;\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/transform~Transform}\r\n     */\r\n    this.transform_ = createTransform();\r\n\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/render/EventType} type Event type.\r\n   * @param {module:ol/PluggableMap~FrameState} frameState Frame state.\r\n   * @private\r\n   */\r\n  dispatchComposeEvent_(type, frameState) {\r\n    const map = this.getMap();\r\n    const context = this.context_;\r\n    if (map.hasListener(type)) {\r\n      const extent = frameState.extent;\r\n      const pixelRatio = frameState.pixelRatio;\r\n      const viewState = frameState.viewState;\r\n      const rotation = viewState.rotation;\r\n\r\n      const transform = this.getTransform(frameState);\r\n\r\n      const vectorContext = new CanvasImmediateRenderer(context, pixelRatio,\r\n        extent, transform, rotation);\r\n      const composeEvent = new RenderEvent(type, vectorContext,\r\n        frameState, context, null);\r\n      map.dispatchEvent(composeEvent);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/PluggableMap~FrameState} frameState Frame state.\r\n   * @protected\r\n   * @return {!module:ol/transform~Transform} Transform.\r\n   */\r\n  getTransform(frameState) {\r\n    const viewState = frameState.viewState;\r\n    const dx1 = this.canvas_.width / 2;\r\n    const dy1 = this.canvas_.height / 2;\r\n    const sx = frameState.pixelRatio / viewState.resolution;\r\n    const sy = -sx;\r\n    const angle = -viewState.rotation;\r\n    const dx2 = -viewState.center[0];\r\n    const dy2 = -viewState.center[1];\r\n    return composeTransform(this.transform_, dx1, dy1, sx, sy, angle, dx2, dy2);\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  renderFrame(frameState) {\r\n\r\n    if (!frameState) {\r\n      if (this.renderedVisible_) {\r\n        this.canvas_.style.display = 'none';\r\n        this.renderedVisible_ = false;\r\n      }\r\n      return;\r\n    }\r\n\r\n    const context = this.context_;\r\n    const pixelRatio = frameState.pixelRatio;\r\n    const width = Math.round(frameState.size[0] * pixelRatio);\r\n    const height = Math.round(frameState.size[1] * pixelRatio);\r\n    if (this.canvas_.width != width || this.canvas_.height != height) {\r\n      this.canvas_.width = width;\r\n      this.canvas_.height = height;\r\n    } else {\r\n      context.clearRect(0, 0, width, height);\r\n    }\r\n\r\n    const rotation = frameState.viewState.rotation;\r\n\r\n    this.calculateMatrices2D(frameState);\r\n\r\n    this.dispatchComposeEvent_(RenderEventType.PRECOMPOSE, frameState);\r\n\r\n    const layerStatesArray = frameState.layerStatesArray;\r\n    stableSort(layerStatesArray, sortByZIndex);\r\n\r\n    if (rotation) {\r\n      context.save();\r\n      rotateAtOffset(context, rotation, width / 2, height / 2);\r\n    }\r\n\r\n    const viewResolution = frameState.viewState.resolution;\r\n    let i, ii, layer, layerRenderer, layerState;\r\n    for (i = 0, ii = layerStatesArray.length; i < ii; ++i) {\r\n      layerState = layerStatesArray[i];\r\n      layer = layerState.layer;\r\n      layerRenderer = /** @type {module:ol/renderer/canvas/Layer} */ (this.getLayerRenderer(layer));\r\n      if (!visibleAtResolution(layerState, viewResolution) ||\r\n          layerState.sourceState != SourceState.READY) {\r\n        continue;\r\n      }\r\n      if (layerRenderer.prepareFrame(frameState, layerState)) {\r\n        layerRenderer.composeFrame(frameState, layerState, context);\r\n      }\r\n    }\r\n\r\n    if (rotation) {\r\n      context.restore();\r\n    }\r\n\r\n    this.dispatchComposeEvent_(RenderEventType.POSTCOMPOSE, frameState);\r\n\r\n    if (!this.renderedVisible_) {\r\n      this.canvas_.style.display = '';\r\n      this.renderedVisible_ = true;\r\n    }\r\n\r\n    this.scheduleRemoveUnusedLayerRenderers(frameState);\r\n    this.scheduleExpireIconCache(frameState);\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  forEachLayerAtPixel(pixel, frameState, hitTolerance, callback, thisArg, layerFilter, thisArg2) {\r\n    let result;\r\n    const viewState = frameState.viewState;\r\n    const viewResolution = viewState.resolution;\r\n\r\n    const layerStates = frameState.layerStatesArray;\r\n    const numLayers = layerStates.length;\r\n\r\n    const coordinate = applyTransform(\r\n      frameState.pixelToCoordinateTransform, pixel.slice());\r\n\r\n    let i;\r\n    for (i = numLayers - 1; i >= 0; --i) {\r\n      const layerState = layerStates[i];\r\n      const layer = layerState.layer;\r\n      if (visibleAtResolution(layerState, viewResolution) && layerFilter.call(thisArg2, layer)) {\r\n        const layerRenderer = /** @type {module:ol/renderer/canvas/Layer} */ (this.getLayerRenderer(layer));\r\n        result = layerRenderer.forEachLayerAtCoordinate(\r\n          coordinate, frameState, hitTolerance, callback, thisArg);\r\n        if (result) {\r\n          return result;\r\n        }\r\n      }\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  registerLayerRenderers(constructors) {\r\n    MapRenderer.prototype.registerLayerRenderers.call(this, constructors);\r\n    for (let i = 0, ii = constructors.length; i < ii; ++i) {\r\n      const ctor = constructors[i];\r\n      if (!includes(layerRendererConstructors, ctor)) {\r\n        layerRendererConstructors.push(ctor);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n\r\nexport default CanvasMapRenderer;\r\n"],"names":["const","super","let","this"],"mappings":"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"}