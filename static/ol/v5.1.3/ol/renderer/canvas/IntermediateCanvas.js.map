{"version":3,"file":"IntermediateCanvas.js","sources":["../../../../src/ol/renderer/canvas/IntermediateCanvas.js"],"sourcesContent":["/**\r\n * @module ol/renderer/canvas/IntermediateCanvas\r\n */\r\nimport {scale as scaleCoordinate} from '../../coordinate.js';\r\nimport {createCanvasContext2D} from '../../dom.js';\r\nimport {containsExtent, intersects} from '../../extent.js';\r\nimport {UNDEFINED} from '../../functions.js';\r\nimport CanvasLayerRenderer from '../canvas/Layer.js';\r\nimport {create as createTransform, apply as applyTransform} from '../../transform.js';\r\n\r\nclass IntermediateCanvasRenderer extends CanvasLayerRenderer {\r\n\r\n  /**\r\n   * @param {module:ol/layer/Layer} layer Layer.\r\n   */\r\n  constructor(layer) {\r\n\r\n    super(layer);\r\n\r\n    /**\r\n     * @protected\r\n     * @type {module:ol/transform~Transform}\r\n     */\r\n    this.coordinateToCanvasPixelTransform = createTransform();\r\n\r\n    /**\r\n     * @private\r\n     * @type {CanvasRenderingContext2D}\r\n     */\r\n    this.hitCanvasContext_ = null;\r\n\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  composeFrame(frameState, layerState, context) {\r\n\r\n    this.preCompose(context, frameState);\r\n\r\n    const image = this.getImage();\r\n    if (image) {\r\n\r\n      // clipped rendering if layer extent is set\r\n      const extent = layerState.extent;\r\n      const clipped = extent !== undefined &&\r\n          !containsExtent(extent, frameState.extent) &&\r\n          intersects(extent, frameState.extent);\r\n      if (clipped) {\r\n        this.clip(context, frameState, /** @type {module:ol/extent~Extent} */ (extent));\r\n      }\r\n\r\n      const imageTransform = this.getImageTransform();\r\n      // for performance reasons, context.save / context.restore is not used\r\n      // to save and restore the transformation matrix and the opacity.\r\n      // see http://jsperf.com/context-save-restore-versus-variable\r\n      const alpha = context.globalAlpha;\r\n      context.globalAlpha = layerState.opacity;\r\n\r\n      // for performance reasons, context.setTransform is only used\r\n      // when the view is rotated. see http://jsperf.com/canvas-transform\r\n      const dx = imageTransform[4];\r\n      const dy = imageTransform[5];\r\n      const dw = image.width * imageTransform[0];\r\n      const dh = image.height * imageTransform[3];\r\n      context.drawImage(image, 0, 0, +image.width, +image.height,\r\n        Math.round(dx), Math.round(dy), Math.round(dw), Math.round(dh));\r\n      context.globalAlpha = alpha;\r\n\r\n      if (clipped) {\r\n        context.restore();\r\n      }\r\n    }\r\n\r\n    this.postCompose(context, frameState, layerState);\r\n  }\r\n\r\n  /**\r\n   * @abstract\r\n   * @return {HTMLCanvasElement|HTMLVideoElement|HTMLImageElement} Canvas.\r\n   */\r\n  getImage() {}\r\n\r\n  /**\r\n   * @abstract\r\n   * @return {!module:ol/transform~Transform} Image transform.\r\n   */\r\n  getImageTransform() {}\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback, thisArg) {\r\n    const layer = this.getLayer();\r\n    const source = layer.getSource();\r\n    const resolution = frameState.viewState.resolution;\r\n    const rotation = frameState.viewState.rotation;\r\n    const skippedFeatureUids = frameState.skippedFeatureUids;\r\n    return source.forEachFeatureAtCoordinate(\r\n      coordinate, resolution, rotation, hitTolerance, skippedFeatureUids,\r\n      /**\r\n       * @param {module:ol/Feature|module:ol/render/Feature} feature Feature.\r\n       * @return {?} Callback result.\r\n       */\r\n      function(feature) {\r\n        return callback.call(thisArg, feature, layer);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  forEachLayerAtCoordinate(coordinate, frameState, hitTolerance, callback, thisArg) {\r\n    if (!this.getImage()) {\r\n      return undefined;\r\n    }\r\n\r\n    if (this.getLayer().getSource().forEachFeatureAtCoordinate !== UNDEFINED) {\r\n      // for ImageCanvas sources use the original hit-detection logic,\r\n      // so that for example also transparent polygons are detected\r\n      return CanvasLayerRenderer.prototype.forEachLayerAtCoordinate.apply(this, arguments);\r\n    } else {\r\n      const pixel = applyTransform(this.coordinateToCanvasPixelTransform, coordinate.slice());\r\n      scaleCoordinate(pixel, frameState.viewState.resolution / this.renderedResolution);\r\n\r\n      if (!this.hitCanvasContext_) {\r\n        this.hitCanvasContext_ = createCanvasContext2D(1, 1);\r\n      }\r\n\r\n      this.hitCanvasContext_.clearRect(0, 0, 1, 1);\r\n      this.hitCanvasContext_.drawImage(this.getImage(), pixel[0], pixel[1], 1, 1, 0, 0, 1, 1);\r\n\r\n      const imageData = this.hitCanvasContext_.getImageData(0, 0, 1, 1).data;\r\n      if (imageData[3] > 0) {\r\n        return callback.call(thisArg, this.getLayer(), imageData);\r\n      } else {\r\n        return undefined;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n\r\nexport default IntermediateCanvasRenderer;\r\n"],"names":["super","const"],"mappings":"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"}