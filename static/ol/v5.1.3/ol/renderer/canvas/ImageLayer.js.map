{"version":3,"file":"ImageLayer.js","sources":["../../../../src/ol/renderer/canvas/ImageLayer.js"],"sourcesContent":["/**\r\n * @module ol/renderer/canvas/ImageLayer\r\n */\r\nimport {ENABLE_RASTER_REPROJECTION} from '../../reproj/common.js';\r\nimport ImageCanvas from '../../ImageCanvas.js';\r\nimport LayerType from '../../LayerType.js';\r\nimport ViewHint from '../../ViewHint.js';\r\nimport {equals} from '../../array.js';\r\nimport {getHeight, getIntersection, getWidth, isEmpty} from '../../extent.js';\r\nimport VectorRenderType from '../../layer/VectorRenderType.js';\r\nimport {assign} from '../../obj.js';\r\nimport {layerRendererConstructors} from './Map.js';\r\nimport IntermediateCanvasRenderer from './IntermediateCanvas.js';\r\nimport {create as createTransform, compose as composeTransform} from '../../transform.js';\r\n\r\n/**\r\n * @classdesc\r\n * Canvas renderer for image layers.\r\n * @api\r\n */\r\nclass CanvasImageLayerRenderer extends IntermediateCanvasRenderer {\r\n\r\n  /**\r\n   * @param {module:ol/layer/Image|module:ol/layer/Vector} imageLayer Image or vector layer.\r\n   */\r\n  constructor(imageLayer) {\r\n\r\n    super(imageLayer);\r\n\r\n    /**\r\n     * @private\r\n     * @type {?module:ol/ImageBase}\r\n     */\r\n    this.image_ = null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/transform~Transform}\r\n     */\r\n    this.imageTransform_ = createTransform();\r\n\r\n    /**\r\n     * @type {!Array.<string>}\r\n     */\r\n    this.skippedFeatures_ = [];\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/renderer/canvas/VectorLayer}\r\n     */\r\n    this.vectorRenderer_ = null;\r\n\r\n    if (imageLayer.getType() === LayerType.VECTOR) {\r\n      for (let i = 0, ii = layerRendererConstructors.length; i < ii; ++i) {\r\n        const ctor = layerRendererConstructors[i];\r\n        if (ctor !== CanvasImageLayerRenderer && ctor['handles'](imageLayer)) {\r\n          this.vectorRenderer_ = new ctor(imageLayer);\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  disposeInternal() {\r\n    if (this.vectorRenderer_) {\r\n      this.vectorRenderer_.dispose();\r\n    }\r\n    IntermediateCanvasRenderer.prototype.disposeInternal.call(this);\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  getImage() {\r\n    return !this.image_ ? null : this.image_.getImage();\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  getImageTransform() {\r\n    return this.imageTransform_;\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  prepareFrame(frameState, layerState) {\r\n\r\n    const pixelRatio = frameState.pixelRatio;\r\n    const size = frameState.size;\r\n    const viewState = frameState.viewState;\r\n    const viewCenter = viewState.center;\r\n    const viewResolution = viewState.resolution;\r\n\r\n    let image;\r\n    const imageLayer = /** @type {module:ol/layer/Image} */ (this.getLayer());\r\n    const imageSource = imageLayer.getSource();\r\n\r\n    const hints = frameState.viewHints;\r\n\r\n    const vectorRenderer = this.vectorRenderer_;\r\n    let renderedExtent = frameState.extent;\r\n    if (!vectorRenderer && layerState.extent !== undefined) {\r\n      renderedExtent = getIntersection(renderedExtent, layerState.extent);\r\n    }\r\n\r\n    if (!hints[ViewHint.ANIMATING] && !hints[ViewHint.INTERACTING] &&\r\n        !isEmpty(renderedExtent)) {\r\n      let projection = viewState.projection;\r\n      if (!ENABLE_RASTER_REPROJECTION) {\r\n        const sourceProjection = imageSource.getProjection();\r\n        if (sourceProjection) {\r\n          projection = sourceProjection;\r\n        }\r\n      }\r\n      let skippedFeatures = this.skippedFeatures_;\r\n      if (vectorRenderer) {\r\n        const context = vectorRenderer.context;\r\n        const imageFrameState = /** @type {module:ol/PluggableMap~FrameState} */ (assign({}, frameState, {\r\n          size: [\r\n            getWidth(renderedExtent) / viewResolution,\r\n            getHeight(renderedExtent) / viewResolution\r\n          ],\r\n          viewState: /** @type {module:ol/View~State} */ (assign({}, frameState.viewState, {\r\n            rotation: 0\r\n          }))\r\n        }));\r\n        const newSkippedFeatures = Object.keys(imageFrameState.skippedFeatureUids).sort();\r\n        image = new ImageCanvas(renderedExtent, viewResolution, pixelRatio, context.canvas, function(callback) {\r\n          if (vectorRenderer.prepareFrame(imageFrameState, layerState) &&\r\n              (vectorRenderer.replayGroupChanged ||\r\n              !equals(skippedFeatures, newSkippedFeatures))) {\r\n            context.canvas.width = imageFrameState.size[0] * pixelRatio;\r\n            context.canvas.height = imageFrameState.size[1] * pixelRatio;\r\n            vectorRenderer.compose(context, imageFrameState, layerState);\r\n            skippedFeatures = newSkippedFeatures;\r\n            callback();\r\n          }\r\n        });\r\n      } else {\r\n        image = imageSource.getImage(\r\n          renderedExtent, viewResolution, pixelRatio, projection);\r\n      }\r\n      if (image && this.loadImage(image)) {\r\n        this.image_ = image;\r\n        this.skippedFeatures_ = skippedFeatures;\r\n      }\r\n    }\r\n\r\n    if (this.image_) {\r\n      image = this.image_;\r\n      const imageExtent = image.getExtent();\r\n      const imageResolution = image.getResolution();\r\n      const imagePixelRatio = image.getPixelRatio();\r\n      const scale = pixelRatio * imageResolution /\r\n          (viewResolution * imagePixelRatio);\r\n      const transform = composeTransform(this.imageTransform_,\r\n        pixelRatio * size[0] / 2, pixelRatio * size[1] / 2,\r\n        scale, scale,\r\n        0,\r\n        imagePixelRatio * (imageExtent[0] - viewCenter[0]) / imageResolution,\r\n        imagePixelRatio * (viewCenter[1] - imageExtent[3]) / imageResolution);\r\n      composeTransform(this.coordinateToCanvasPixelTransform,\r\n        pixelRatio * size[0] / 2 - transform[4], pixelRatio * size[1] / 2 - transform[5],\r\n        pixelRatio / viewResolution, -pixelRatio / viewResolution,\r\n        0,\r\n        -viewCenter[0], -viewCenter[1]);\r\n\r\n      this.renderedResolution = imageResolution * pixelRatio / imagePixelRatio;\r\n    }\r\n\r\n    return !!this.image_;\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback, thisArg) {\r\n    if (this.vectorRenderer_) {\r\n      return this.vectorRenderer_.forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback, thisArg);\r\n    } else {\r\n      return IntermediateCanvasRenderer.prototype.forEachFeatureAtCoordinate.call(this, coordinate, frameState, hitTolerance, callback, thisArg);\r\n    }\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * Determine if this renderer handles the provided layer.\r\n * @param {module:ol/layer/Layer} layer The candidate layer.\r\n * @return {boolean} The renderer can render the layer.\r\n */\r\nCanvasImageLayerRenderer['handles'] = function(layer) {\r\n  return layer.getType() === LayerType.IMAGE ||\r\n    layer.getType() === LayerType.VECTOR &&\r\n    /** @type {module:ol/layer/Vector} */ (layer).getRenderMode() === VectorRenderType.IMAGE;\r\n};\r\n\r\n\r\n/**\r\n * Create a layer renderer.\r\n * @param {module:ol/renderer/Map} mapRenderer The map renderer.\r\n * @param {module:ol/layer/Layer} layer The layer to be rendererd.\r\n * @return {module:ol/renderer/canvas/ImageLayer} The layer renderer.\r\n */\r\nCanvasImageLayerRenderer['create'] = function(mapRenderer, layer) {\r\n  return new CanvasImageLayerRenderer(/** @type {module:ol/layer/Image} */ (layer));\r\n};\r\n\r\n\r\nexport default CanvasImageLayerRenderer;\r\n"],"names":["super","let","const","this"],"mappings":"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"}