{"version":3,"file":"VectorLayer.js","sources":["../../../../src/ol/renderer/canvas/VectorLayer.js"],"sourcesContent":["/**\r\n * @module ol/renderer/canvas/VectorLayer\r\n */\r\nimport {getUid} from '../../util.js';\r\nimport LayerType from '../../LayerType.js';\r\nimport ViewHint from '../../ViewHint.js';\r\nimport {createCanvasContext2D} from '../../dom.js';\r\nimport {listen, unlisten} from '../../events.js';\r\nimport EventType from '../../events/EventType.js';\r\nimport rbush from 'rbush';\r\nimport {buffer, createEmpty, containsExtent, getWidth} from '../../extent.js';\r\nimport RenderEventType from '../../render/EventType.js';\r\nimport {labelCache, rotateAtOffset} from '../../render/canvas.js';\r\nimport CanvasReplayGroup from '../../render/canvas/ReplayGroup.js';\r\nimport CanvasLayerRenderer from '../canvas/Layer.js';\r\nimport {defaultOrder as defaultRenderOrder, getTolerance as getRenderTolerance, getSquaredTolerance as getSquaredRenderTolerance, renderFeature} from '../vector.js';\r\n\r\n/**\r\n * @classdesc\r\n * Canvas renderer for vector layers.\r\n * @api\r\n */\r\nclass CanvasVectorLayerRenderer extends CanvasLayerRenderer {\r\n\r\n  /**\r\n   * @param {module:ol/layer/Vector} vectorLayer Vector layer.\r\n   */\r\n  constructor(vectorLayer) {\r\n\r\n    super(vectorLayer);\r\n\r\n    /**\r\n     * Declutter tree.\r\n     * @private\r\n     */\r\n    this.declutterTree_ = vectorLayer.getDeclutter() ? rbush(9, undefined) : null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {boolean}\r\n     */\r\n    this.dirty_ = false;\r\n\r\n    /**\r\n     * @private\r\n     * @type {number}\r\n     */\r\n    this.renderedRevision_ = -1;\r\n\r\n    /**\r\n     * @private\r\n     * @type {number}\r\n     */\r\n    this.renderedResolution_ = NaN;\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/extent~Extent}\r\n     */\r\n    this.renderedExtent_ = createEmpty();\r\n\r\n    /**\r\n     * @private\r\n     * @type {function(module:ol/Feature, module:ol/Feature): number|null}\r\n     */\r\n    this.renderedRenderOrder_ = null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/render/canvas/ReplayGroup}\r\n     */\r\n    this.replayGroup_ = null;\r\n\r\n    /**\r\n     * A new replay group had to be created by `prepareFrame()`\r\n     * @type {boolean}\r\n     */\r\n    this.replayGroupChanged = true;\r\n\r\n    /**\r\n     * @type {CanvasRenderingContext2D}\r\n     */\r\n    this.context = createCanvasContext2D();\r\n\r\n    listen(labelCache, EventType.CLEAR, this.handleFontsChanged_, this);\r\n\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  disposeInternal() {\r\n    unlisten(labelCache, EventType.CLEAR, this.handleFontsChanged_, this);\r\n    CanvasLayerRenderer.prototype.disposeInternal.call(this);\r\n  }\r\n\r\n  /**\r\n   * @param {CanvasRenderingContext2D} context Context.\r\n   * @param {module:ol/PluggableMap~FrameState} frameState Frame state.\r\n   * @param {module:ol/layer/Layer~State} layerState Layer state.\r\n   */\r\n  compose(context, frameState, layerState) {\r\n    const extent = frameState.extent;\r\n    const pixelRatio = frameState.pixelRatio;\r\n    const skippedFeatureUids = layerState.managed ?\r\n      frameState.skippedFeatureUids : {};\r\n    const viewState = frameState.viewState;\r\n    const projection = viewState.projection;\r\n    const rotation = viewState.rotation;\r\n    const projectionExtent = projection.getExtent();\r\n    const vectorSource = /** @type {module:ol/source/Vector} */ (this.getLayer().getSource());\r\n\r\n    let transform = this.getTransform(frameState, 0);\r\n\r\n    // clipped rendering if layer extent is set\r\n    const clipExtent = layerState.extent;\r\n    const clipped = clipExtent !== undefined;\r\n    if (clipped) {\r\n      this.clip(context, frameState, /** @type {module:ol/extent~Extent} */ (clipExtent));\r\n    }\r\n    const replayGroup = this.replayGroup_;\r\n    if (replayGroup && !replayGroup.isEmpty()) {\r\n      if (this.declutterTree_) {\r\n        this.declutterTree_.clear();\r\n      }\r\n      const layer = /** @type {module:ol/layer/Vector} */ (this.getLayer());\r\n      let drawOffsetX = 0;\r\n      let drawOffsetY = 0;\r\n      let replayContext;\r\n      const transparentLayer = layerState.opacity !== 1;\r\n      const hasRenderListeners = layer.hasListener(RenderEventType.RENDER);\r\n      if (transparentLayer || hasRenderListeners) {\r\n        let drawWidth = context.canvas.width;\r\n        let drawHeight = context.canvas.height;\r\n        if (rotation) {\r\n          const drawSize = Math.round(Math.sqrt(drawWidth * drawWidth + drawHeight * drawHeight));\r\n          drawOffsetX = (drawSize - drawWidth) / 2;\r\n          drawOffsetY = (drawSize - drawHeight) / 2;\r\n          drawWidth = drawHeight = drawSize;\r\n        }\r\n        // resize and clear\r\n        this.context.canvas.width = drawWidth;\r\n        this.context.canvas.height = drawHeight;\r\n        replayContext = this.context;\r\n      } else {\r\n        replayContext = context;\r\n      }\r\n\r\n      const alpha = replayContext.globalAlpha;\r\n      if (!transparentLayer) {\r\n        // for performance reasons, context.save / context.restore is not used\r\n        // to save and restore the transformation matrix and the opacity.\r\n        // see http://jsperf.com/context-save-restore-versus-variable\r\n        replayContext.globalAlpha = layerState.opacity;\r\n      }\r\n\r\n      if (replayContext != context) {\r\n        replayContext.translate(drawOffsetX, drawOffsetY);\r\n      }\r\n\r\n      const width = frameState.size[0] * pixelRatio;\r\n      const height = frameState.size[1] * pixelRatio;\r\n      rotateAtOffset(replayContext, -rotation,\r\n        width / 2, height / 2);\r\n      replayGroup.replay(replayContext, transform, rotation, skippedFeatureUids);\r\n      if (vectorSource.getWrapX() && projection.canWrapX() &&\r\n          !containsExtent(projectionExtent, extent)) {\r\n        let startX = extent[0];\r\n        const worldWidth = getWidth(projectionExtent);\r\n        let world = 0;\r\n        let offsetX;\r\n        while (startX < projectionExtent[0]) {\r\n          --world;\r\n          offsetX = worldWidth * world;\r\n          transform = this.getTransform(frameState, offsetX);\r\n          replayGroup.replay(replayContext, transform, rotation, skippedFeatureUids);\r\n          startX += worldWidth;\r\n        }\r\n        world = 0;\r\n        startX = extent[2];\r\n        while (startX > projectionExtent[2]) {\r\n          ++world;\r\n          offsetX = worldWidth * world;\r\n          transform = this.getTransform(frameState, offsetX);\r\n          replayGroup.replay(replayContext, transform, rotation, skippedFeatureUids);\r\n          startX -= worldWidth;\r\n        }\r\n      }\r\n      rotateAtOffset(replayContext, rotation,\r\n        width / 2, height / 2);\r\n\r\n      if (hasRenderListeners) {\r\n        this.dispatchRenderEvent(replayContext, frameState, transform);\r\n      }\r\n      if (replayContext != context) {\r\n        if (transparentLayer) {\r\n          const mainContextAlpha = context.globalAlpha;\r\n          context.globalAlpha = layerState.opacity;\r\n          context.drawImage(replayContext.canvas, -drawOffsetX, -drawOffsetY);\r\n          context.globalAlpha = mainContextAlpha;\r\n        } else {\r\n          context.drawImage(replayContext.canvas, -drawOffsetX, -drawOffsetY);\r\n        }\r\n        replayContext.translate(-drawOffsetX, -drawOffsetY);\r\n      }\r\n\r\n      if (!transparentLayer) {\r\n        replayContext.globalAlpha = alpha;\r\n      }\r\n    }\r\n\r\n    if (clipped) {\r\n      context.restore();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  composeFrame(frameState, layerState, context) {\r\n    const transform = this.getTransform(frameState, 0);\r\n    this.preCompose(context, frameState, transform);\r\n    this.compose(context, frameState, layerState);\r\n    this.postCompose(context, frameState, layerState, transform);\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback, thisArg) {\r\n    if (!this.replayGroup_) {\r\n      return undefined;\r\n    } else {\r\n      const resolution = frameState.viewState.resolution;\r\n      const rotation = frameState.viewState.rotation;\r\n      const layer = /** @type {module:ol/layer/Vector} */ (this.getLayer());\r\n      /** @type {!Object.<string, boolean>} */\r\n      const features = {};\r\n      const result = this.replayGroup_.forEachFeatureAtCoordinate(coordinate, resolution, rotation, hitTolerance, {},\r\n        /**\r\n         * @param {module:ol/Feature|module:ol/render/Feature} feature Feature.\r\n         * @return {?} Callback result.\r\n         */\r\n        function(feature) {\r\n          const key = getUid(feature).toString();\r\n          if (!(key in features)) {\r\n            features[key] = true;\r\n            return callback.call(thisArg, feature, layer);\r\n          }\r\n        }, null);\r\n      return result;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/events/Event} event Event.\r\n   */\r\n  handleFontsChanged_(event) {\r\n    const layer = this.getLayer();\r\n    if (layer.getVisible() && this.replayGroup_) {\r\n      layer.changed();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle changes in image style state.\r\n   * @param {module:ol/events/Event} event Image style change event.\r\n   * @private\r\n   */\r\n  handleStyleImageChange_(event) {\r\n    this.renderIfReadyAndVisible();\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  prepareFrame(frameState, layerState) {\r\n    const vectorLayer = /** @type {module:ol/layer/Vector} */ (this.getLayer());\r\n    const vectorSource = vectorLayer.getSource();\r\n\r\n    const animating = frameState.viewHints[ViewHint.ANIMATING];\r\n    const interacting = frameState.viewHints[ViewHint.INTERACTING];\r\n    const updateWhileAnimating = vectorLayer.getUpdateWhileAnimating();\r\n    const updateWhileInteracting = vectorLayer.getUpdateWhileInteracting();\r\n\r\n    if (!this.dirty_ && (!updateWhileAnimating && animating) ||\r\n        (!updateWhileInteracting && interacting)) {\r\n      return true;\r\n    }\r\n\r\n    const frameStateExtent = frameState.extent;\r\n    const viewState = frameState.viewState;\r\n    const projection = viewState.projection;\r\n    const resolution = viewState.resolution;\r\n    const pixelRatio = frameState.pixelRatio;\r\n    const vectorLayerRevision = vectorLayer.getRevision();\r\n    const vectorLayerRenderBuffer = vectorLayer.getRenderBuffer();\r\n    let vectorLayerRenderOrder = vectorLayer.getRenderOrder();\r\n\r\n    if (vectorLayerRenderOrder === undefined) {\r\n      vectorLayerRenderOrder = defaultRenderOrder;\r\n    }\r\n\r\n    const extent = buffer(frameStateExtent,\r\n      vectorLayerRenderBuffer * resolution);\r\n    const projectionExtent = viewState.projection.getExtent();\r\n\r\n    if (vectorSource.getWrapX() && viewState.projection.canWrapX() &&\r\n        !containsExtent(projectionExtent, frameState.extent)) {\r\n      // For the replay group, we need an extent that intersects the real world\r\n      // (-180° to +180°). To support geometries in a coordinate range from -540°\r\n      // to +540°, we add at least 1 world width on each side of the projection\r\n      // extent. If the viewport is wider than the world, we need to add half of\r\n      // the viewport width to make sure we cover the whole viewport.\r\n      const worldWidth = getWidth(projectionExtent);\r\n      const gutter = Math.max(getWidth(extent) / 2, worldWidth);\r\n      extent[0] = projectionExtent[0] - gutter;\r\n      extent[2] = projectionExtent[2] + gutter;\r\n    }\r\n\r\n    if (!this.dirty_ &&\r\n        this.renderedResolution_ == resolution &&\r\n        this.renderedRevision_ == vectorLayerRevision &&\r\n        this.renderedRenderOrder_ == vectorLayerRenderOrder &&\r\n        containsExtent(this.renderedExtent_, extent)) {\r\n      this.replayGroupChanged = false;\r\n      return true;\r\n    }\r\n\r\n    this.replayGroup_ = null;\r\n\r\n    this.dirty_ = false;\r\n\r\n    const replayGroup = new CanvasReplayGroup(\r\n      getRenderTolerance(resolution, pixelRatio), extent, resolution,\r\n      pixelRatio, vectorSource.getOverlaps(), this.declutterTree_, vectorLayer.getRenderBuffer());\r\n    vectorSource.loadFeatures(extent, resolution, projection);\r\n    /**\r\n     * @param {module:ol/Feature} feature Feature.\r\n     * @this {module:ol/renderer/canvas/VectorLayer}\r\n     */\r\n    const render = function(feature) {\r\n      let styles;\r\n      const styleFunction = feature.getStyleFunction() || vectorLayer.getStyleFunction();\r\n      if (styleFunction) {\r\n        styles = styleFunction(feature, resolution);\r\n      }\r\n      if (styles) {\r\n        const dirty = this.renderFeature(\r\n          feature, resolution, pixelRatio, styles, replayGroup);\r\n        this.dirty_ = this.dirty_ || dirty;\r\n      }\r\n    }.bind(this);\r\n    if (vectorLayerRenderOrder) {\r\n      /** @type {Array.<module:ol/Feature>} */\r\n      const features = [];\r\n      vectorSource.forEachFeatureInExtent(extent,\r\n        /**\r\n         * @param {module:ol/Feature} feature Feature.\r\n         */\r\n        function(feature) {\r\n          features.push(feature);\r\n        }, this);\r\n      features.sort(vectorLayerRenderOrder);\r\n      for (let i = 0, ii = features.length; i < ii; ++i) {\r\n        render(features[i]);\r\n      }\r\n    } else {\r\n      vectorSource.forEachFeatureInExtent(extent, render, this);\r\n    }\r\n    replayGroup.finish();\r\n\r\n    this.renderedResolution_ = resolution;\r\n    this.renderedRevision_ = vectorLayerRevision;\r\n    this.renderedRenderOrder_ = vectorLayerRenderOrder;\r\n    this.renderedExtent_ = extent;\r\n    this.replayGroup_ = replayGroup;\r\n\r\n    this.replayGroupChanged = true;\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/Feature} feature Feature.\r\n   * @param {number} resolution Resolution.\r\n   * @param {number} pixelRatio Pixel ratio.\r\n   * @param {(module:ol/style/Style|Array.<module:ol/style/Style>)} styles The style or array of styles.\r\n   * @param {module:ol/render/canvas/ReplayGroup} replayGroup Replay group.\r\n   * @return {boolean} `true` if an image is loading.\r\n   */\r\n  renderFeature(feature, resolution, pixelRatio, styles, replayGroup) {\r\n    if (!styles) {\r\n      return false;\r\n    }\r\n    let loading = false;\r\n    if (Array.isArray(styles)) {\r\n      for (let i = 0, ii = styles.length; i < ii; ++i) {\r\n        loading = renderFeature(\r\n          replayGroup, feature, styles[i],\r\n          getSquaredRenderTolerance(resolution, pixelRatio),\r\n          this.handleStyleImageChange_, this) || loading;\r\n      }\r\n    } else {\r\n      loading = renderFeature(\r\n        replayGroup, feature, styles,\r\n        getSquaredRenderTolerance(resolution, pixelRatio),\r\n        this.handleStyleImageChange_, this);\r\n    }\r\n    return loading;\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * Determine if this renderer handles the provided layer.\r\n * @param {module:ol/layer/Layer} layer The candidate layer.\r\n * @return {boolean} The renderer can render the layer.\r\n */\r\nCanvasVectorLayerRenderer['handles'] = function(layer) {\r\n  return layer.getType() === LayerType.VECTOR;\r\n};\r\n\r\n\r\n/**\r\n * Create a layer renderer.\r\n * @param {module:ol/renderer/Map} mapRenderer The map renderer.\r\n * @param {module:ol/layer/Layer} layer The layer to be rendererd.\r\n * @return {module:ol/renderer/canvas/VectorLayer} The layer renderer.\r\n */\r\nCanvasVectorLayerRenderer['create'] = function(mapRenderer, layer) {\r\n  return new CanvasVectorLayerRenderer(/** @type {module:ol/layer/Vector} */ (layer));\r\n};\r\n\r\n\r\nexport default CanvasVectorLayerRenderer;\r\n"],"names":["super","const","let","this"],"mappings":"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"}