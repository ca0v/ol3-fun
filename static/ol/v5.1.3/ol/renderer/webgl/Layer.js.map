{"version":3,"file":"Layer.js","sources":["../../../../src/ol/renderer/webgl/Layer.js"],"sourcesContent":["/**\r\n * @module ol/renderer/webgl/Layer\r\n */\r\nimport RenderEvent from '../../render/Event.js';\r\nimport RenderEventType from '../../render/EventType.js';\r\nimport WebGLImmediateRenderer from '../../render/webgl/Immediate.js';\r\nimport LayerRenderer from '../Layer.js';\r\nimport {fragment, vertex} from '../webgl/defaultmapshader.js';\r\nimport Locations from '../webgl/defaultmapshader/Locations.js';\r\nimport {create as createTransform} from '../../transform.js';\r\nimport {create, fromTransform} from '../../vec/mat4.js';\r\nimport {ARRAY_BUFFER, FRAMEBUFFER, FLOAT, TEXTURE_2D,\r\n  TRIANGLE_STRIP, COLOR_ATTACHMENT0} from '../../webgl.js';\r\nimport WebGLBuffer from '../../webgl/Buffer.js';\r\nimport {createEmptyTexture} from '../../webgl/Context.js';\r\n\r\nclass WebGLLayerRenderer extends LayerRenderer {\r\n\r\n  /**\r\n   * @param {module:ol/renderer/webgl/Map} mapRenderer Map renderer.\r\n   * @param {module:ol/layer/Layer} layer Layer.\r\n   */\r\n  constructor(mapRenderer, layer) {\r\n\r\n    super(layer);\r\n\r\n    /**\r\n     * @protected\r\n     * @type {module:ol/renderer/webgl/Map}\r\n     */\r\n    this.mapRenderer = mapRenderer;\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/webgl/Buffer}\r\n     */\r\n    this.arrayBuffer_ = new WebGLBuffer([\r\n      -1, -1, 0, 0,\r\n      1, -1, 1, 0,\r\n      -1, 1, 0, 1,\r\n      1, 1, 1, 1\r\n    ]);\r\n\r\n    /**\r\n     * @protected\r\n     * @type {WebGLTexture}\r\n     */\r\n    this.texture = null;\r\n\r\n    /**\r\n     * @protected\r\n     * @type {WebGLFramebuffer}\r\n     */\r\n    this.framebuffer = null;\r\n\r\n    /**\r\n     * @protected\r\n     * @type {number|undefined}\r\n     */\r\n    this.framebufferDimension = undefined;\r\n\r\n    /**\r\n     * @protected\r\n     * @type {module:ol/transform~Transform}\r\n     */\r\n    this.texCoordMatrix = createTransform();\r\n\r\n    /**\r\n     * @protected\r\n     * @type {module:ol/transform~Transform}\r\n     */\r\n    this.projectionMatrix = createTransform();\r\n\r\n    /**\r\n     * @type {Array.<number>}\r\n     * @private\r\n     */\r\n    this.tmpMat4_ = create();\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/renderer/webgl/defaultmapshader/Locations}\r\n     */\r\n    this.defaultLocations_ = null;\r\n\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/PluggableMap~FrameState} frameState Frame state.\r\n   * @param {number} framebufferDimension Framebuffer dimension.\r\n   * @protected\r\n   */\r\n  bindFramebuffer(frameState, framebufferDimension) {\r\n\r\n    const gl = this.mapRenderer.getGL();\r\n\r\n    if (this.framebufferDimension === undefined ||\r\n        this.framebufferDimension != framebufferDimension) {\r\n      /**\r\n       * @param {WebGLRenderingContext} gl GL.\r\n       * @param {WebGLFramebuffer} framebuffer Framebuffer.\r\n       * @param {WebGLTexture} texture Texture.\r\n       */\r\n      const postRenderFunction = function(gl, framebuffer, texture) {\r\n        if (!gl.isContextLost()) {\r\n          gl.deleteFramebuffer(framebuffer);\r\n          gl.deleteTexture(texture);\r\n        }\r\n      }.bind(null, gl, this.framebuffer, this.texture);\r\n\r\n      frameState.postRenderFunctions.push(\r\n        /** @type {module:ol/PluggableMap~PostRenderFunction} */ (postRenderFunction)\r\n      );\r\n\r\n      const texture = createEmptyTexture(\r\n        gl, framebufferDimension, framebufferDimension);\r\n\r\n      const framebuffer = gl.createFramebuffer();\r\n      gl.bindFramebuffer(FRAMEBUFFER, framebuffer);\r\n      gl.framebufferTexture2D(FRAMEBUFFER,\r\n        COLOR_ATTACHMENT0, TEXTURE_2D, texture, 0);\r\n\r\n      this.texture = texture;\r\n      this.framebuffer = framebuffer;\r\n      this.framebufferDimension = framebufferDimension;\r\n\r\n    } else {\r\n      gl.bindFramebuffer(FRAMEBUFFER, this.framebuffer);\r\n    }\r\n\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/PluggableMap~FrameState} frameState Frame state.\r\n   * @param {module:ol/layer/Layer~State} layerState Layer state.\r\n   * @param {module:ol/webgl/Context} context Context.\r\n   */\r\n  composeFrame(frameState, layerState, context) {\r\n\r\n    this.dispatchComposeEvent_(RenderEventType.PRECOMPOSE, context, frameState);\r\n\r\n    context.bindBuffer(ARRAY_BUFFER, this.arrayBuffer_);\r\n\r\n    const gl = context.getGL();\r\n\r\n    const program = context.getProgram(fragment, vertex);\r\n\r\n    let locations;\r\n    if (!this.defaultLocations_) {\r\n      locations = new Locations(gl, program);\r\n      this.defaultLocations_ = locations;\r\n    } else {\r\n      locations = this.defaultLocations_;\r\n    }\r\n\r\n    if (context.useProgram(program)) {\r\n      gl.enableVertexAttribArray(locations.a_position);\r\n      gl.vertexAttribPointer(\r\n        locations.a_position, 2, FLOAT, false, 16, 0);\r\n      gl.enableVertexAttribArray(locations.a_texCoord);\r\n      gl.vertexAttribPointer(\r\n        locations.a_texCoord, 2, FLOAT, false, 16, 8);\r\n      gl.uniform1i(locations.u_texture, 0);\r\n    }\r\n\r\n    gl.uniformMatrix4fv(locations.u_texCoordMatrix, false,\r\n      fromTransform(this.tmpMat4_, this.getTexCoordMatrix()));\r\n    gl.uniformMatrix4fv(locations.u_projectionMatrix, false,\r\n      fromTransform(this.tmpMat4_, this.getProjectionMatrix()));\r\n    gl.uniform1f(locations.u_opacity, layerState.opacity);\r\n    gl.bindTexture(TEXTURE_2D, this.getTexture());\r\n    gl.drawArrays(TRIANGLE_STRIP, 0, 4);\r\n\r\n    this.dispatchComposeEvent_(RenderEventType.POSTCOMPOSE, context, frameState);\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/render/EventType} type Event type.\r\n   * @param {module:ol/webgl/Context} context WebGL context.\r\n   * @param {module:ol/PluggableMap~FrameState} frameState Frame state.\r\n   * @private\r\n   */\r\n  dispatchComposeEvent_(type, context, frameState) {\r\n    const layer = this.getLayer();\r\n    if (layer.hasListener(type)) {\r\n      const viewState = frameState.viewState;\r\n      const resolution = viewState.resolution;\r\n      const pixelRatio = frameState.pixelRatio;\r\n      const extent = frameState.extent;\r\n      const center = viewState.center;\r\n      const rotation = viewState.rotation;\r\n      const size = frameState.size;\r\n\r\n      const render = new WebGLImmediateRenderer(\r\n        context, center, resolution, rotation, size, extent, pixelRatio);\r\n      const composeEvent = new RenderEvent(\r\n        type, render, frameState, null, context);\r\n      layer.dispatchEvent(composeEvent);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @return {!module:ol/transform~Transform} Matrix.\r\n   */\r\n  getTexCoordMatrix() {\r\n    return this.texCoordMatrix;\r\n  }\r\n\r\n  /**\r\n   * @return {WebGLTexture} Texture.\r\n   */\r\n  getTexture() {\r\n    return this.texture;\r\n  }\r\n\r\n  /**\r\n   * @return {!module:ol/transform~Transform} Matrix.\r\n   */\r\n  getProjectionMatrix() {\r\n    return this.projectionMatrix;\r\n  }\r\n\r\n  /**\r\n   * Handle webglcontextlost.\r\n   */\r\n  handleWebGLContextLost() {\r\n    this.texture = null;\r\n    this.framebuffer = null;\r\n    this.framebufferDimension = undefined;\r\n  }\r\n\r\n  /**\r\n   * @abstract\r\n   * @param {module:ol/PluggableMap~FrameState} frameState Frame state.\r\n   * @param {module:ol/layer/Layer~State} layerState Layer state.\r\n   * @param {module:ol/webgl/Context} context Context.\r\n   * @return {boolean} whether composeFrame should be called.\r\n   */\r\n  prepareFrame(frameState, layerState, context) {}\r\n\r\n  /**\r\n   * @abstract\r\n   * @param {module:ol/pixel~Pixel} pixel Pixel.\r\n   * @param {module:ol/PluggableMap~FrameState} frameState FrameState.\r\n   * @param {function(this: S, module:ol/layer/Layer, (Uint8ClampedArray|Uint8Array)): T} callback Layer\r\n   *     callback.\r\n   * @param {S} thisArg Value to use as `this` when executing `callback`.\r\n   * @return {T|undefined} Callback result.\r\n   * @template S,T,U\r\n   */\r\n  forEachLayerAtPixel(pixel, frameState, callback, thisArg) {}\r\n}\r\n\r\n\r\nexport default WebGLLayerRenderer;\r\n"],"names":["super","const","let"],"mappings":"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"}