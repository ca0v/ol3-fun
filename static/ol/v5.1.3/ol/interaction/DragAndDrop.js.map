{"version":3,"file":"DragAndDrop.js","sources":["../../../src/ol/interaction/DragAndDrop.js"],"sourcesContent":["/**\r\n * @module ol/interaction/DragAndDrop\r\n */\r\n// FIXME should handle all geo-referenced data, not just vector data\r\n\r\nimport {TRUE} from '../functions.js';\r\nimport {listen, unlistenByKey} from '../events.js';\r\nimport Event from '../events/Event.js';\r\nimport EventType from '../events/EventType.js';\r\nimport Interaction from '../interaction/Interaction.js';\r\nimport {get as getProjection} from '../proj.js';\r\n\r\n\r\n/**\r\n * @typedef {Object} Options\r\n * @property {Array.<function(new: module:ol/format/Feature)>} [formatConstructors] Format constructors.\r\n * @property {module:ol/source/Vector} [source] Optional vector source where features will be added.  If a source is provided\r\n * all existing features will be removed and new features will be added when\r\n * they are dropped on the target.  If you want to add features to a vector\r\n * source without removing the existing features (append only), instead of\r\n * providing the source option listen for the \"addfeatures\" event.\r\n * @property {module:ol/proj~ProjectionLike} [projection] Target projection. By default, the map's view's projection is used.\r\n * @property {Element} [target] The element that is used as the drop target, default is the viewport element.\r\n */\r\n\r\n\r\n/**\r\n * @enum {string}\r\n */\r\nconst DragAndDropEventType = {\r\n  /**\r\n   * Triggered when features are added\r\n   * @event module:ol/interaction/DragAndDrop~DragAndDropEvent#addfeatures\r\n   * @api\r\n   */\r\n  ADD_FEATURES: 'addfeatures'\r\n};\r\n\r\n\r\n/**\r\n * @classdesc\r\n * Events emitted by {@link module:ol/interaction/DragAndDrop~DragAndDrop} instances are instances\r\n * of this type.\r\n */\r\nclass DragAndDropEvent extends Event {\r\n\r\n  /**\r\n   * @param {module:ol/interaction/DragAndDrop~DragAndDropEventType} type Type.\r\n   * @param {File} file File.\r\n   * @param {Array.<module:ol/Feature>=} opt_features Features.\r\n   * @param {module:ol/proj/Projection=} opt_projection Projection.\r\n   */\r\n  constructor(type, file, opt_features, opt_projection) {\r\n\r\n    super(type);\r\n\r\n    /**\r\n     * The features parsed from dropped data.\r\n     * @type {Array.<module:ol/Feature>|undefined}\r\n     * @api\r\n     */\r\n    this.features = opt_features;\r\n\r\n    /**\r\n     * The dropped file.\r\n     * @type {File}\r\n     * @api\r\n     */\r\n    this.file = file;\r\n\r\n    /**\r\n     * The feature projection.\r\n     * @type {module:ol/proj/Projection|undefined}\r\n     * @api\r\n     */\r\n    this.projection = opt_projection;\r\n\r\n  }\r\n\r\n}\r\n\r\n\r\n/**\r\n * @classdesc\r\n * Handles input of vector data by drag and drop.\r\n * @api\r\n *\r\n * @fires module:ol/interaction/DragAndDrop~DragAndDropEvent\r\n */\r\nclass DragAndDrop extends Interaction {\r\n  /**\r\n   * @param {module:ol/interaction/DragAndDrop~Options=} opt_options Options.\r\n   */\r\n  constructor(opt_options) {\r\n\r\n    const options = opt_options ? opt_options : {};\r\n\r\n    super({\r\n      handleEvent: TRUE\r\n    });\r\n\r\n    /**\r\n     * @private\r\n     * @type {Array.<function(new: module:ol/format/Feature)>}\r\n     */\r\n    this.formatConstructors_ = options.formatConstructors ?\r\n      options.formatConstructors : [];\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/proj/Projection}\r\n     */\r\n    this.projection_ = options.projection ?\r\n      getProjection(options.projection) : null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {Array.<module:ol/events~EventsKey>}\r\n     */\r\n    this.dropListenKeys_ = null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/source/Vector}\r\n     */\r\n    this.source_ = options.source || null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {Element}\r\n     */\r\n    this.target = options.target ? options.target : null;\r\n\r\n  }\r\n\r\n  /**\r\n   * @param {File} file File.\r\n   * @param {Event} event Load event.\r\n   * @private\r\n   */\r\n  handleResult_(file, event) {\r\n    const result = event.target.result;\r\n    const map = this.getMap();\r\n    let projection = this.projection_;\r\n    if (!projection) {\r\n      const view = map.getView();\r\n      projection = view.getProjection();\r\n    }\r\n\r\n    const formatConstructors = this.formatConstructors_;\r\n    let features = [];\r\n    for (let i = 0, ii = formatConstructors.length; i < ii; ++i) {\r\n      /**\r\n       * Avoid \"cannot instantiate abstract class\" error.\r\n       * @type {Function}\r\n       */\r\n      const formatConstructor = formatConstructors[i];\r\n      /**\r\n       * @type {module:ol/format/Feature}\r\n       */\r\n      const format = new formatConstructor();\r\n      features = this.tryReadFeatures_(format, result, {\r\n        featureProjection: projection\r\n      });\r\n      if (features && features.length > 0) {\r\n        break;\r\n      }\r\n    }\r\n    if (this.source_) {\r\n      this.source_.clear();\r\n      this.source_.addFeatures(features);\r\n    }\r\n    this.dispatchEvent(\r\n      new DragAndDropEvent(\r\n        DragAndDropEventType.ADD_FEATURES, file,\r\n        features, projection));\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  registerListeners_() {\r\n    const map = this.getMap();\r\n    if (map) {\r\n      const dropArea = this.target ? this.target : map.getViewport();\r\n      this.dropListenKeys_ = [\r\n        listen(dropArea, EventType.DROP, handleDrop, this),\r\n        listen(dropArea, EventType.DRAGENTER, handleStop, this),\r\n        listen(dropArea, EventType.DRAGOVER, handleStop, this),\r\n        listen(dropArea, EventType.DROP, handleStop, this)\r\n      ];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  setActive(active) {\r\n    super.setActive(active);\r\n    if (active) {\r\n      this.registerListeners_();\r\n    } else {\r\n      this.unregisterListeners_();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  setMap(map) {\r\n    this.unregisterListeners_();\r\n    super.setMap(map);\r\n    if (this.getActive()) {\r\n      this.registerListeners_();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/format/Feature} format Format.\r\n   * @param {string} text Text.\r\n   * @param {module:ol/format/Feature~ReadOptions} options Read options.\r\n   * @private\r\n   * @return {Array.<module:ol/Feature>} Features.\r\n   */\r\n  tryReadFeatures_(format, text, options) {\r\n    try {\r\n      return format.readFeatures(text, options);\r\n    } catch (e) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  unregisterListeners_() {\r\n    if (this.dropListenKeys_) {\r\n      this.dropListenKeys_.forEach(unlistenByKey);\r\n      this.dropListenKeys_ = null;\r\n    }\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * @param {DragEvent} event Event.\r\n * @this {module:ol/interaction/DragAndDrop}\r\n */\r\nfunction handleDrop(event) {\r\n  const files = event.dataTransfer.files;\r\n  for (let i = 0, ii = files.length; i < ii; ++i) {\r\n    const file = files.item(i);\r\n    const reader = new FileReader();\r\n    reader.addEventListener(EventType.LOAD, this.handleResult_.bind(this, file));\r\n    reader.readAsText(file);\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * @param {DragEvent} event Event.\r\n */\r\nfunction handleStop(event) {\r\n  event.stopPropagation();\r\n  event.preventDefault();\r\n  event.dataTransfer.dropEffect = 'copy';\r\n}\r\n\r\n\r\nexport default DragAndDrop;\r\n"],"names":["const","super","let","this"],"mappings":"AAAA;;;;;AAKA,QAAQ,IAAI,OAAO,iBAAiB,CAAC;AACrC,QAAQ,MAAM,EAAE,aAAa,OAAO,cAAc,CAAC;AACnD,OAAO,KAAK,MAAM,oBAAoB,CAAC;AACvC,OAAO,SAAS,MAAM,wBAAwB,CAAC;AAC/C,OAAO,WAAW,MAAM,+BAA+B,CAAC;AACxD,QAAQ,GAAG,IAAI,aAAa,OAAO,YAAY,CAAC;;;;;;;;;;;;;;;;;;;AAmBhDA,GAAK,CAAC,oBAAoB,GAAG;;;;;;EAM3B,YAAY,EAAE,aAAa;CAC5B,CAAC;;;;;;;;AAQF,IAAM,gBAAgB,GAAc;EAQlC,yBAAW,CAAC,IAAI,EAAE,IAAI,EAAE,YAAY,EAAE,cAAc,EAAE;;IAEpDC,UAAK,OAAC,IAAI,CAAC,CAAC;;;;;;;IAOZ,IAAI,CAAC,QAAQ,GAAG,YAAY,CAAC;;;;;;;IAO7B,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC;;;;;;;IAOjB,IAAI,CAAC,UAAU,GAAG,cAAc,CAAC;;;;;;GAElC;;;EAjC4B,QAmC9B;;;;;;;;;;AAUD,IAAM,WAAW,GAAoB;EAInC,oBAAW,CAAC,WAAW,EAAE;;IAEvBD,GAAK,CAAC,OAAO,GAAG,WAAW,GAAG,WAAW,GAAG,EAAE,CAAC;;IAE/CC,gBAAK,OAAC;MACJ,WAAW,EAAE,IAAI;KAClB,CAAC,CAAC;;;;;;IAMH,IAAI,CAAC,mBAAmB,GAAG,OAAO,CAAC,kBAAkB;MACnD,OAAO,CAAC,kBAAkB,GAAG,EAAE,CAAC;;;;;;IAMlC,IAAI,CAAC,WAAW,GAAG,OAAO,CAAC,UAAU;MACnC,aAAa,CAAC,OAAO,CAAC,UAAU,CAAC,GAAG,IAAI,CAAC;;;;;;IAM3C,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;;;;;;IAM5B,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC,MAAM,IAAI,IAAI,CAAC;;;;;;IAMtC,IAAI,CAAC,MAAM,GAAG,OAAO,CAAC,MAAM,GAAG,OAAO,CAAC,MAAM,GAAG,IAAI,CAAC;;;;;;kDAEtD;;;;;;;wBAOD,uCAAa,CAAC,IAAI,EAAE,KAAK,EAAE;;AAAC;IAC1BD,GAAK,CAAC,MAAM,GAAG,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC;IACnCA,GAAK,CAAC,GAAG,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC;IAC1BE,GAAG,CAAC,UAAU,GAAG,IAAI,CAAC,WAAW,CAAC;IAClC,IAAI,CAAC,UAAU,EAAE;MACfF,GAAK,CAAC,IAAI,GAAG,GAAG,CAAC,OAAO,EAAE,CAAC;MAC3B,UAAU,GAAG,IAAI,CAAC,aAAa,EAAE,CAAC;KACnC;;IAEDA,GAAK,CAAC,kBAAkB,GAAG,IAAI,CAAC,mBAAmB,CAAC;IACpDE,GAAG,CAAC,QAAQ,GAAG,EAAE,CAAC;IAClB,KAAKA,GAAG,CAAC,CAAC,GAAG,CAAC,EAAE,EAAE,GAAG,kBAAkB,CAAC,MAAM,EAAE,CAAC,GAAG,EAAE,EAAE,EAAE,CAAC,EAAE;;;;;MAK3DF,GAAK,CAAC,iBAAiB,GAAG,kBAAkB,CAAC,CAAC,CAAC,CAAC;;;;MAIhDA,GAAK,CAAC,MAAM,GAAG,IAAI,iBAAiB,EAAE,CAAC;MACvC,QAAQ,GAAGG,MAAI,CAAC,gBAAgB,CAAC,MAAM,EAAE,MAAM,EAAE;QAC/C,iBAAiB,EAAE,UAAU;OAC9B,CAAC,CAAC;MACH,IAAI,QAAQ,IAAI,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE;QACnC,MAAM;OACP;KACF;IACD,IAAI,IAAI,CAAC,OAAO,EAAE;MAChB,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC;MACrB,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;KACpC;IACD,IAAI,CAAC,aAAa;MAChB,IAAI,gBAAgB;QAClB,oBAAoB,CAAC,YAAY,EAAE,IAAI;QACvC,QAAQ,EAAE,UAAU,CAAC,CAAC,CAAC;IAC5B;;;;;wBAKD,iDAAkB,GAAG;IACnBH,GAAK,CAAC,GAAG,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC;IAC1B,IAAI,GAAG,EAAE;MACPA,GAAK,CAAC,QAAQ,GAAG,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,MAAM,GAAG,GAAG,CAAC,WAAW,EAAE,CAAC;MAC/D,IAAI,CAAC,eAAe,GAAG;QACrB,MAAM,CAAC,QAAQ,EAAE,SAAS,CAAC,IAAI,EAAE,UAAU,EAAE,IAAI,CAAC;QAClD,MAAM,CAAC,QAAQ,EAAE,SAAS,CAAC,SAAS,EAAE,UAAU,EAAE,IAAI,CAAC;QACvD,MAAM,CAAC,QAAQ,EAAE,SAAS,CAAC,QAAQ,EAAE,UAAU,EAAE,IAAI,CAAC;QACtD,MAAM,CAAC,QAAQ,EAAE,SAAS,CAAC,IAAI,EAAE,UAAU,EAAE,IAAI,CAAC;OACnD,CAAC;KACH;IACF;;;;;wBAKD,+BAAS,CAAC,MAAM,EAAE;IAChBC,qBAAK,CAAC,cAAS,OAAC,MAAM,CAAC,CAAC;IACxB,IAAI,MAAM,EAAE;MACV,IAAI,CAAC,kBAAkB,EAAE,CAAC;KAC3B,MAAM;MACL,IAAI,CAAC,oBAAoB,EAAE,CAAC;KAC7B;IACF;;;;;wBAKD,yBAAM,CAAC,GAAG,EAAE;IACV,IAAI,CAAC,oBAAoB,EAAE,CAAC;IAC5BA,qBAAK,CAAC,WAAM,OAAC,GAAG,CAAC,CAAC;IAClB,IAAI,IAAI,CAAC,SAAS,EAAE,EAAE;MACpB,IAAI,CAAC,kBAAkB,EAAE,CAAC;KAC3B;IACF;;;;;;;;;wBASD,6CAAgB,CAAC,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE;IACtC,IAAI;MACF,OAAO,MAAM,CAAC,YAAY,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;KAC3C,CAAC,OAAO,CAAC,EAAE;MACV,OAAO,IAAI,CAAC;KACb;IACF;;;;;wBAKD,qDAAoB,GAAG;IACrB,IAAI,IAAI,CAAC,eAAe,EAAE;MACxB,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,aAAa,CAAC,CAAC;MAC5C,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;KAC7B;GACF;;;EAvJuB,cAwJzB;;;;;;;AAOD,SAAS,UAAU,CAAC,KAAK,EAAE;;AAAC;EAC1BD,GAAK,CAAC,KAAK,GAAG,KAAK,CAAC,YAAY,CAAC,KAAK,CAAC;EACvC,KAAKE,GAAG,CAAC,CAAC,GAAG,CAAC,EAAE,EAAE,GAAG,KAAK,CAAC,MAAM,EAAE,CAAC,GAAG,EAAE,EAAE,EAAE,CAAC,EAAE;IAC9CF,GAAK,CAAC,IAAI,GAAG,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;IAC3BA,GAAK,CAAC,MAAM,GAAG,IAAI,UAAU,EAAE,CAAC;IAChC,MAAM,CAAC,gBAAgB,CAAC,SAAS,CAAC,IAAI,EAAEG,MAAI,CAAC,aAAa,CAAC,IAAI,CAACA,MAAI,EAAE,IAAI,CAAC,CAAC,CAAC;IAC7E,MAAM,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;GACzB;CACF;;;;;;AAMD,SAAS,UAAU,CAAC,KAAK,EAAE;EACzB,KAAK,CAAC,eAAe,EAAE,CAAC;EACxB,KAAK,CAAC,cAAc,EAAE,CAAC;EACvB,KAAK,CAAC,YAAY,CAAC,UAAU,GAAG,MAAM,CAAC;CACxC;;;AAGD,eAAe,WAAW,CAAC;"}