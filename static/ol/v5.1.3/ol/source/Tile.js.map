{"version":3,"file":"Tile.js","sources":["../../../src/ol/source/Tile.js"],"sourcesContent":["/**\r\n * @module ol/source/Tile\r\n */\r\n\r\nimport {UNDEFINED} from '../functions.js';\r\nimport TileCache from '../TileCache.js';\r\nimport TileState from '../TileState.js';\r\nimport Event from '../events/Event.js';\r\nimport {equivalent} from '../proj.js';\r\nimport {toSize, scale as scaleSize} from '../size.js';\r\nimport Source from '../source/Source.js';\r\nimport {getKeyZXY, withinExtentAndZ} from '../tilecoord.js';\r\nimport {wrapX, getForProjection as getTileGridForProjection} from '../tilegrid.js';\r\n\r\n/**\r\n * @typedef {Object} Options\r\n * @property {module:ol/source/Source~AttributionLike} [attributions]\r\n * @property {number} [cacheSize]\r\n * @property {module:ol/extent~Extent} [extent]\r\n * @property {boolean} [opaque]\r\n * @property {number} [tilePixelRatio]\r\n * @property {module:ol/proj~ProjectionLike} [projection]\r\n * @property {module:ol/source/State} [state]\r\n * @property {module:ol/tilegrid/TileGrid} [tileGrid]\r\n * @property {boolean} [wrapX=true]\r\n * @property {number} [transition]\r\n */\r\n\r\n\r\n/**\r\n * @classdesc\r\n * Abstract base class; normally only used for creating subclasses and not\r\n * instantiated in apps.\r\n * Base class for sources providing images divided into a tile grid.\r\n * @api\r\n */\r\nclass TileSource extends Source {\r\n  /**\r\n   * @param {module:ol/source/Tile~Options=} options SourceTile source options.\r\n   */\r\n  constructor(options) {\r\n\r\n    super({\r\n      attributions: options.attributions,\r\n      extent: options.extent,\r\n      projection: options.projection,\r\n      state: options.state,\r\n      wrapX: options.wrapX\r\n    });\r\n\r\n    /**\r\n     * @private\r\n     * @type {boolean}\r\n     */\r\n    this.opaque_ = options.opaque !== undefined ? options.opaque : false;\r\n\r\n    /**\r\n     * @private\r\n     * @type {number}\r\n     */\r\n    this.tilePixelRatio_ = options.tilePixelRatio !== undefined ?\r\n      options.tilePixelRatio : 1;\r\n\r\n    /**\r\n     * @protected\r\n     * @type {module:ol/tilegrid/TileGrid}\r\n     */\r\n    this.tileGrid = options.tileGrid !== undefined ? options.tileGrid : null;\r\n\r\n    /**\r\n     * @protected\r\n     * @type {module:ol/TileCache}\r\n     */\r\n    this.tileCache = new TileCache(options.cacheSize);\r\n\r\n    /**\r\n     * @protected\r\n     * @type {module:ol/size~Size}\r\n     */\r\n    this.tmpSize = [0, 0];\r\n\r\n    /**\r\n     * @private\r\n     * @type {string}\r\n     */\r\n    this.key_ = '';\r\n\r\n    /**\r\n     * @protected\r\n     * @type {module:ol/Tile~Options}\r\n     */\r\n    this.tileOptions = {transition: options.transition};\r\n\r\n  }\r\n\r\n  /**\r\n   * @return {boolean} Can expire cache.\r\n   */\r\n  canExpireCache() {\r\n    return this.tileCache.canExpireCache();\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/proj/Projection} projection Projection.\r\n   * @param {!Object.<string, module:ol/TileRange>} usedTiles Used tiles.\r\n   */\r\n  expireCache(projection, usedTiles) {\r\n    const tileCache = this.getTileCacheForProjection(projection);\r\n    if (tileCache) {\r\n      tileCache.expireCache(usedTiles);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/proj/Projection} projection Projection.\r\n   * @param {number} z Zoom level.\r\n   * @param {module:ol/TileRange} tileRange Tile range.\r\n   * @param {function(module:ol/Tile):(boolean|undefined)} callback Called with each\r\n   *     loaded tile.  If the callback returns `false`, the tile will not be\r\n   *     considered loaded.\r\n   * @return {boolean} The tile range is fully covered with loaded tiles.\r\n   */\r\n  forEachLoadedTile(projection, z, tileRange, callback) {\r\n    const tileCache = this.getTileCacheForProjection(projection);\r\n    if (!tileCache) {\r\n      return false;\r\n    }\r\n\r\n    let covered = true;\r\n    let tile, tileCoordKey, loaded;\r\n    for (let x = tileRange.minX; x <= tileRange.maxX; ++x) {\r\n      for (let y = tileRange.minY; y <= tileRange.maxY; ++y) {\r\n        tileCoordKey = getKeyZXY(z, x, y);\r\n        loaded = false;\r\n        if (tileCache.containsKey(tileCoordKey)) {\r\n          tile = /** @type {!module:ol/Tile} */ (tileCache.get(tileCoordKey));\r\n          loaded = tile.getState() === TileState.LOADED;\r\n          if (loaded) {\r\n            loaded = (callback(tile) !== false);\r\n          }\r\n        }\r\n        if (!loaded) {\r\n          covered = false;\r\n        }\r\n      }\r\n    }\r\n    return covered;\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/proj/Projection} projection Projection.\r\n   * @return {number} Gutter.\r\n   */\r\n  getGutter(projection) {\r\n    return 0;\r\n  }\r\n\r\n  /**\r\n   * Return the key to be used for all tiles in the source.\r\n   * @return {string} The key for all tiles.\r\n   * @protected\r\n   */\r\n  getKey() {\r\n    return this.key_;\r\n  }\r\n\r\n  /**\r\n   * Set the value to be used as the key for all tiles in the source.\r\n   * @param {string} key The key for tiles.\r\n   * @protected\r\n   */\r\n  setKey(key) {\r\n    if (this.key_ !== key) {\r\n      this.key_ = key;\r\n      this.changed();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/proj/Projection} projection Projection.\r\n   * @return {boolean} Opaque.\r\n   */\r\n  getOpaque(projection) {\r\n    return this.opaque_;\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  getResolutions() {\r\n    return this.tileGrid.getResolutions();\r\n  }\r\n\r\n  /**\r\n   * @abstract\r\n   * @param {number} z Tile coordinate z.\r\n   * @param {number} x Tile coordinate x.\r\n   * @param {number} y Tile coordinate y.\r\n   * @param {number} pixelRatio Pixel ratio.\r\n   * @param {module:ol/proj/Projection} projection Projection.\r\n   * @return {!module:ol/Tile} Tile.\r\n   */\r\n  getTile(z, x, y, pixelRatio, projection) {}\r\n\r\n  /**\r\n   * Return the tile grid of the tile source.\r\n   * @return {module:ol/tilegrid/TileGrid} Tile grid.\r\n   * @api\r\n   */\r\n  getTileGrid() {\r\n    return this.tileGrid;\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/proj/Projection} projection Projection.\r\n   * @return {!module:ol/tilegrid/TileGrid} Tile grid.\r\n   */\r\n  getTileGridForProjection(projection) {\r\n    if (!this.tileGrid) {\r\n      return getTileGridForProjection(projection);\r\n    } else {\r\n      return this.tileGrid;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {module:ol/proj/Projection} projection Projection.\r\n   * @return {module:ol/TileCache} Tile cache.\r\n   * @protected\r\n   */\r\n  getTileCacheForProjection(projection) {\r\n    const thisProj = this.getProjection();\r\n    if (thisProj && !equivalent(thisProj, projection)) {\r\n      return null;\r\n    } else {\r\n      return this.tileCache;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the tile pixel ratio for this source. Subclasses may override this\r\n   * method, which is meant to return a supported pixel ratio that matches the\r\n   * provided `pixelRatio` as close as possible.\r\n   * @param {number} pixelRatio Pixel ratio.\r\n   * @return {number} Tile pixel ratio.\r\n   */\r\n  getTilePixelRatio(pixelRatio) {\r\n    return this.tilePixelRatio_;\r\n  }\r\n\r\n  /**\r\n   * @param {number} z Z.\r\n   * @param {number} pixelRatio Pixel ratio.\r\n   * @param {module:ol/proj/Projection} projection Projection.\r\n   * @return {module:ol/size~Size} Tile size.\r\n   */\r\n  getTilePixelSize(z, pixelRatio, projection) {\r\n    const tileGrid = this.getTileGridForProjection(projection);\r\n    const tilePixelRatio = this.getTilePixelRatio(pixelRatio);\r\n    const tileSize = toSize(tileGrid.getTileSize(z), this.tmpSize);\r\n    if (tilePixelRatio == 1) {\r\n      return tileSize;\r\n    } else {\r\n      return scaleSize(tileSize, tilePixelRatio, this.tmpSize);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a tile coordinate wrapped around the x-axis. When the tile coordinate\r\n   * is outside the resolution and extent range of the tile grid, `null` will be\r\n   * returned.\r\n   * @param {module:ol/tilecoord~TileCoord} tileCoord Tile coordinate.\r\n   * @param {module:ol/proj/Projection=} opt_projection Projection.\r\n   * @return {module:ol/tilecoord~TileCoord} Tile coordinate to be passed to the tileUrlFunction or\r\n   *     null if no tile URL should be created for the passed `tileCoord`.\r\n   */\r\n  getTileCoordForTileUrlFunction(tileCoord, opt_projection) {\r\n    const projection = opt_projection !== undefined ?\r\n      opt_projection : this.getProjection();\r\n    const tileGrid = this.getTileGridForProjection(projection);\r\n    if (this.getWrapX() && projection.isGlobal()) {\r\n      tileCoord = wrapX(tileGrid, tileCoord, projection);\r\n    }\r\n    return withinExtentAndZ(tileCoord, tileGrid) ? tileCoord : null;\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  refresh() {\r\n    this.tileCache.clear();\r\n    this.changed();\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * Marks a tile coord as being used, without triggering a load.\r\n * @param {number} z Tile coordinate z.\r\n * @param {number} x Tile coordinate x.\r\n * @param {number} y Tile coordinate y.\r\n * @param {module:ol/proj/Projection} projection Projection.\r\n */\r\nTileSource.prototype.useTile = UNDEFINED;\r\n\r\n\r\n/**\r\n * @classdesc\r\n * Events emitted by {@link module:ol/source/Tile~TileSource} instances are instances of this\r\n * type.\r\n */\r\nexport class TileSourceEvent extends Event {\r\n  /**\r\n   * @param {string} type Type.\r\n   * @param {module:ol/Tile} tile The tile.\r\n   */\r\n  constructor(type, tile) {\r\n\r\n    super(type);\r\n\r\n    /**\r\n     * The tile related to the event.\r\n     * @type {module:ol/Tile}\r\n     * @api\r\n     */\r\n    this.tile = tile;\r\n\r\n  }\r\n\r\n}\r\n\r\nexport default TileSource;\r\n"],"names":["super","const","let"],"mappings":"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"}