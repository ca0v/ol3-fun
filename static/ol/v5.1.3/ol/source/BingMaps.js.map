{"version":3,"file":"BingMaps.js","sources":["../../../src/ol/source/BingMaps.js"],"sourcesContent":["/**\r\n * @module ol/source/BingMaps\r\n */\r\n\r\nimport {createFromTileUrlFunctions} from '../tileurlfunction.js';\r\nimport {applyTransform, intersects} from '../extent.js';\r\nimport {jsonp as requestJSONP} from '../net.js';\r\nimport {get as getProjection, getTransformFromProjections} from '../proj.js';\r\nimport SourceState from '../source/State.js';\r\nimport TileImage from '../source/TileImage.js';\r\nimport {createOrUpdate, quadKey} from '../tilecoord.js';\r\nimport {createXYZ, extentFromProjection} from '../tilegrid.js';\r\n\r\n\r\n/**\r\n * The attribution containing a link to the Microsoft® Bing™ Maps Platform APIs’\r\n * Terms Of Use.\r\n * @const\r\n * @type {string}\r\n */\r\nconst TOS_ATTRIBUTION = '<a class=\"ol-attribution-bing-tos\" ' +\r\n      'href=\"https://www.microsoft.com/maps/product/terms.html\">' +\r\n      'Terms of Use</a>';\r\n\r\n\r\n/**\r\n * @typedef {Object} Options\r\n * @property {number} [cacheSize=2048] Cache size.\r\n * @property {boolean} [hidpi=false] If `true` hidpi tiles will be requested.\r\n * @property {string} [culture='en-us'] Culture code.\r\n * @property {string} key Bing Maps API key. Get yours at http://www.bingmapsportal.com/.\r\n * @property {string} imagerySet Type of imagery.\r\n * @property {number} [maxZoom=21] Max zoom. Default is what's advertized by the BingMaps service.\r\n * @property {number} [reprojectionErrorThreshold=0.5] Maximum allowed reprojection error (in pixels).\r\n * Higher values can increase reprojection performance, but decrease precision.\r\n * @property {module:ol/Tile~LoadFunction} [tileLoadFunction] Optional function to load a tile given a URL. The default is\r\n * ```js\r\n * function(imageTile, src) {\r\n *   imageTile.getImage().src = src;\r\n * };\r\n * ```\r\n * @property {boolean} [wrapX=true] Whether to wrap the world horizontally.\r\n * @property {number} [transition] Duration of the opacity transition for rendering.\r\n * To disable the opacity transition, pass `transition: 0`.\r\n */\r\n\r\n\r\n/**\r\n * @classdesc\r\n * Layer source for Bing Maps tile data.\r\n * @api\r\n */\r\nclass BingMaps extends TileImage {\r\n  /**\r\n   * @param {module:ol/source/BingMaps~Options=} options Bing Maps options.\r\n   */\r\n  constructor(options) {\r\n\r\n    const hidpi = options.hidpi !== undefined ? options.hidpi : false;\r\n\r\n    super({\r\n      cacheSize: options.cacheSize,\r\n      crossOrigin: 'anonymous',\r\n      opaque: true,\r\n      projection: getProjection('EPSG:3857'),\r\n      reprojectionErrorThreshold: options.reprojectionErrorThreshold,\r\n      state: SourceState.LOADING,\r\n      tileLoadFunction: options.tileLoadFunction,\r\n      tilePixelRatio: hidpi ? 2 : 1,\r\n      wrapX: options.wrapX !== undefined ? options.wrapX : true,\r\n      transition: options.transition\r\n    });\r\n\r\n    /**\r\n     * @private\r\n     * @type {boolean}\r\n     */\r\n    this.hidpi_ = hidpi;\r\n\r\n\r\n    /**\r\n     * @private\r\n     * @type {string}\r\n     */\r\n    this.culture_ = options.culture !== undefined ? options.culture : 'en-us';\r\n\r\n    /**\r\n     * @private\r\n     * @type {number}\r\n     */\r\n    this.maxZoom_ = options.maxZoom !== undefined ? options.maxZoom : -1;\r\n\r\n    /**\r\n     * @private\r\n     * @type {string}\r\n     */\r\n    this.apiKey_ = options.key;\r\n\r\n    /**\r\n     * @private\r\n     * @type {string}\r\n     */\r\n    this.imagerySet_ = options.imagerySet;\r\n\r\n    const url = 'https://dev.virtualearth.net/REST/v1/Imagery/Metadata/' +\r\n        this.imagerySet_ +\r\n        '?uriScheme=https&include=ImageryProviders&key=' + this.apiKey_ +\r\n        '&c=' + this.culture_;\r\n\r\n    requestJSONP(url, this.handleImageryMetadataResponse.bind(this), undefined,\r\n      'jsonp');\r\n\r\n  }\r\n\r\n  /**\r\n   * Get the api key used for this source.\r\n   *\r\n   * @return {string} The api key.\r\n   * @api\r\n   */\r\n  getApiKey() {\r\n    return this.apiKey_;\r\n  }\r\n\r\n  /**\r\n   * Get the imagery set associated with this source.\r\n   *\r\n   * @return {string} The imagery set.\r\n   * @api\r\n   */\r\n  getImagerySet() {\r\n    return this.imagerySet_;\r\n  }\r\n\r\n  /**\r\n   * @param {BingMapsImageryMetadataResponse} response Response.\r\n   */\r\n  handleImageryMetadataResponse(response) {\r\n    if (response.statusCode != 200 ||\r\n        response.statusDescription != 'OK' ||\r\n        response.authenticationResultCode != 'ValidCredentials' ||\r\n        response.resourceSets.length != 1 ||\r\n        response.resourceSets[0].resources.length != 1) {\r\n      this.setState(SourceState.ERROR);\r\n      return;\r\n    }\r\n\r\n    const resource = response.resourceSets[0].resources[0];\r\n    const maxZoom = this.maxZoom_ == -1 ? resource.zoomMax : this.maxZoom_;\r\n\r\n    const sourceProjection = this.getProjection();\r\n    const extent = extentFromProjection(sourceProjection);\r\n    const tileSize = resource.imageWidth == resource.imageHeight ?\r\n      resource.imageWidth : [resource.imageWidth, resource.imageHeight];\r\n    const tileGrid = createXYZ({\r\n      extent: extent,\r\n      minZoom: resource.zoomMin,\r\n      maxZoom: maxZoom,\r\n      tileSize: tileSize / (this.hidpi_ ? 2 : 1)\r\n    });\r\n    this.tileGrid = tileGrid;\r\n\r\n    const culture = this.culture_;\r\n    const hidpi = this.hidpi_;\r\n    this.tileUrlFunction = createFromTileUrlFunctions(\r\n      resource.imageUrlSubdomains.map(function(subdomain) {\r\n        const quadKeyTileCoord = [0, 0, 0];\r\n        const imageUrl = resource.imageUrl\r\n          .replace('{subdomain}', subdomain)\r\n          .replace('{culture}', culture);\r\n        return (\r\n          /**\r\n           * @param {module:ol/tilecoord~TileCoord} tileCoord Tile coordinate.\r\n           * @param {number} pixelRatio Pixel ratio.\r\n           * @param {module:ol/proj/Projection} projection Projection.\r\n           * @return {string|undefined} Tile URL.\r\n           */\r\n          function(tileCoord, pixelRatio, projection) {\r\n            if (!tileCoord) {\r\n              return undefined;\r\n            } else {\r\n              createOrUpdate(tileCoord[0], tileCoord[1], -tileCoord[2] - 1, quadKeyTileCoord);\r\n              let url = imageUrl;\r\n              if (hidpi) {\r\n                url += '&dpi=d1&device=mobile';\r\n              }\r\n              return url.replace('{quadkey}', quadKey(quadKeyTileCoord));\r\n            }\r\n          }\r\n        );\r\n      }));\r\n\r\n    if (resource.imageryProviders) {\r\n      const transform = getTransformFromProjections(\r\n        getProjection('EPSG:4326'), this.getProjection());\r\n\r\n      this.setAttributions(function(frameState) {\r\n        const attributions = [];\r\n        const zoom = frameState.viewState.zoom;\r\n        resource.imageryProviders.map(function(imageryProvider) {\r\n          let intersecting = false;\r\n          const coverageAreas = imageryProvider.coverageAreas;\r\n          for (let i = 0, ii = coverageAreas.length; i < ii; ++i) {\r\n            const coverageArea = coverageAreas[i];\r\n            if (zoom >= coverageArea.zoomMin && zoom <= coverageArea.zoomMax) {\r\n              const bbox = coverageArea.bbox;\r\n              const epsg4326Extent = [bbox[1], bbox[0], bbox[3], bbox[2]];\r\n              const extent = applyTransform(epsg4326Extent, transform);\r\n              if (intersects(extent, frameState.extent)) {\r\n                intersecting = true;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n          if (intersecting) {\r\n            attributions.push(imageryProvider.attribution);\r\n          }\r\n        });\r\n\r\n        attributions.push(TOS_ATTRIBUTION);\r\n        return attributions;\r\n      });\r\n    }\r\n\r\n    this.setState(SourceState.READY);\r\n  }\r\n}\r\n\r\nexport default BingMaps;\r\n"],"names":["const","super","let"],"mappings":"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"}