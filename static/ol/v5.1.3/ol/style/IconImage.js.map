{"version":3,"file":"IconImage.js","sources":["../../../src/ol/style/IconImage.js"],"sourcesContent":["/**\r\n * @module ol/style/IconImage\r\n */\r\n\r\nimport {createCanvasContext2D} from '../dom.js';\r\nimport {listenOnce, unlistenByKey} from '../events.js';\r\nimport EventTarget from '../events/EventTarget.js';\r\nimport EventType from '../events/EventType.js';\r\nimport ImageState from '../ImageState.js';\r\nimport {shared as iconImageCache} from '../style/IconImageCache.js';\r\n\r\nclass IconImage extends EventTarget {\r\n  /**\r\n   * @param {HTMLImageElement|HTMLCanvasElement} image Image.\r\n   * @param {string|undefined} src Src.\r\n   * @param {module:ol/size~Size} size Size.\r\n   * @param {?string} crossOrigin Cross origin.\r\n   * @param {module:ol/ImageState} imageState Image state.\r\n   * @param {module:ol/color~Color} color Color.\r\n   */\r\n  constructor(image, src, size, crossOrigin, imageState, color) {\r\n\r\n    super();\r\n\r\n    /**\r\n     * @private\r\n     * @type {HTMLImageElement|HTMLCanvasElement}\r\n     */\r\n    this.hitDetectionImage_ = null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {HTMLImageElement|HTMLCanvasElement}\r\n     */\r\n    this.image_ = !image ? new Image() : image;\r\n\r\n    if (crossOrigin !== null) {\r\n      this.image_.crossOrigin = crossOrigin;\r\n    }\r\n\r\n    /**\r\n     * @private\r\n     * @type {HTMLCanvasElement}\r\n     */\r\n    this.canvas_ = color ?\r\n      /** @type {HTMLCanvasElement} */ (document.createElement('CANVAS')) :\r\n      null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/color~Color}\r\n     */\r\n    this.color_ = color;\r\n\r\n    /**\r\n     * @private\r\n     * @type {Array.<module:ol/events~EventsKey>}\r\n     */\r\n    this.imageListenerKeys_ = null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/ImageState}\r\n     */\r\n    this.imageState_ = imageState;\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/size~Size}\r\n     */\r\n    this.size_ = size;\r\n\r\n    /**\r\n     * @private\r\n     * @type {string|undefined}\r\n     */\r\n    this.src_ = src;\r\n\r\n    /**\r\n     * @private\r\n     * @type {boolean}\r\n     */\r\n    this.tainting_ = false;\r\n    if (this.imageState_ == ImageState.LOADED) {\r\n      this.determineTainting_();\r\n    }\r\n\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  determineTainting_() {\r\n    const context = createCanvasContext2D(1, 1);\r\n    try {\r\n      context.drawImage(this.image_, 0, 0);\r\n      context.getImageData(0, 0, 1, 1);\r\n    } catch (e) {\r\n      this.tainting_ = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  dispatchChangeEvent_() {\r\n    this.dispatchEvent(EventType.CHANGE);\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  handleImageError_() {\r\n    this.imageState_ = ImageState.ERROR;\r\n    this.unlistenImage_();\r\n    this.dispatchChangeEvent_();\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  handleImageLoad_() {\r\n    this.imageState_ = ImageState.LOADED;\r\n    if (this.size_) {\r\n      this.image_.width = this.size_[0];\r\n      this.image_.height = this.size_[1];\r\n    }\r\n    this.size_ = [this.image_.width, this.image_.height];\r\n    this.unlistenImage_();\r\n    this.determineTainting_();\r\n    this.replaceColor_();\r\n    this.dispatchChangeEvent_();\r\n  }\r\n\r\n  /**\r\n   * @param {number} pixelRatio Pixel ratio.\r\n   * @return {HTMLImageElement|HTMLCanvasElement} Image or Canvas element.\r\n   */\r\n  getImage(pixelRatio) {\r\n    return this.canvas_ ? this.canvas_ : this.image_;\r\n  }\r\n\r\n  /**\r\n   * @return {module:ol/ImageState} Image state.\r\n   */\r\n  getImageState() {\r\n    return this.imageState_;\r\n  }\r\n\r\n  /**\r\n   * @param {number} pixelRatio Pixel ratio.\r\n   * @return {HTMLImageElement|HTMLCanvasElement} Image element.\r\n   */\r\n  getHitDetectionImage(pixelRatio) {\r\n    if (!this.hitDetectionImage_) {\r\n      if (this.tainting_) {\r\n        const width = this.size_[0];\r\n        const height = this.size_[1];\r\n        const context = createCanvasContext2D(width, height);\r\n        context.fillRect(0, 0, width, height);\r\n        this.hitDetectionImage_ = context.canvas;\r\n      } else {\r\n        this.hitDetectionImage_ = this.image_;\r\n      }\r\n    }\r\n    return this.hitDetectionImage_;\r\n  }\r\n\r\n  /**\r\n   * @return {module:ol/size~Size} Image size.\r\n   */\r\n  getSize() {\r\n    return this.size_;\r\n  }\r\n\r\n  /**\r\n   * @return {string|undefined} Image src.\r\n   */\r\n  getSrc() {\r\n    return this.src_;\r\n  }\r\n\r\n  /**\r\n   * Load not yet loaded URI.\r\n   */\r\n  load() {\r\n    if (this.imageState_ == ImageState.IDLE) {\r\n      this.imageState_ = ImageState.LOADING;\r\n      this.imageListenerKeys_ = [\r\n        listenOnce(this.image_, EventType.ERROR,\r\n          this.handleImageError_, this),\r\n        listenOnce(this.image_, EventType.LOAD,\r\n          this.handleImageLoad_, this)\r\n      ];\r\n      try {\r\n        this.image_.src = this.src_;\r\n      } catch (e) {\r\n        this.handleImageError_();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  replaceColor_() {\r\n    if (this.tainting_ || this.color_ === null) {\r\n      return;\r\n    }\r\n\r\n    this.canvas_.width = this.image_.width;\r\n    this.canvas_.height = this.image_.height;\r\n\r\n    const ctx = this.canvas_.getContext('2d');\r\n    ctx.drawImage(this.image_, 0, 0);\r\n\r\n    const imgData = ctx.getImageData(0, 0, this.image_.width, this.image_.height);\r\n    const data = imgData.data;\r\n    const r = this.color_[0] / 255.0;\r\n    const g = this.color_[1] / 255.0;\r\n    const b = this.color_[2] / 255.0;\r\n\r\n    for (let i = 0, ii = data.length; i < ii; i += 4) {\r\n      data[i] *= r;\r\n      data[i + 1] *= g;\r\n      data[i + 2] *= b;\r\n    }\r\n    ctx.putImageData(imgData, 0, 0);\r\n  }\r\n\r\n  /**\r\n   * Discards event handlers which listen for load completion or errors.\r\n   *\r\n   * @private\r\n   */\r\n  unlistenImage_() {\r\n    this.imageListenerKeys_.forEach(unlistenByKey);\r\n    this.imageListenerKeys_ = null;\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * @param {HTMLImageElement|HTMLCanvasElement} image Image.\r\n * @param {string} src Src.\r\n * @param {module:ol/size~Size} size Size.\r\n * @param {?string} crossOrigin Cross origin.\r\n * @param {module:ol/ImageState} imageState Image state.\r\n * @param {module:ol/color~Color} color Color.\r\n * @return {module:ol/style/IconImage} Icon image.\r\n */\r\nexport function get(image, src, size, crossOrigin, imageState, color) {\r\n  let iconImage = iconImageCache.get(src, crossOrigin, color);\r\n  if (!iconImage) {\r\n    iconImage = new IconImage(image, src, size, crossOrigin, imageState, color);\r\n    iconImageCache.set(src, crossOrigin, color, iconImage);\r\n  }\r\n  return iconImage;\r\n}\r\n\r\n\r\nexport default IconImage;\r\n"],"names":["super","const","let"],"mappings":"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"}