{"version":3,"file":"canvas.js","sources":["../../../src/ol/render/canvas.js"],"sourcesContent":["/**\r\n * @module ol/render/canvas\r\n */\r\nimport {getFontFamilies} from '../css.js';\r\nimport {createCanvasContext2D} from '../dom.js';\r\nimport {clear} from '../obj.js';\r\nimport LRUCache from '../structs/LRUCache.js';\r\nimport {create as createTransform} from '../transform.js';\r\n\r\n\r\n/**\r\n * @typedef {Object} FillState\r\n * @property {module:ol/colorlike~ColorLike} fillStyle\r\n */\r\n\r\n\r\n/**\r\n * @typedef {Object} FillStrokeState\r\n * @property {module:ol/colorlike~ColorLike} [currentFillStyle]\r\n * @property {module:ol/colorlike~ColorLike} [currentStrokeStyle]\r\n * @property {string} [currentLineCap]\r\n * @property {Array.<number>} currentLineDash\r\n * @property {number} [currentLineDashOffset]\r\n * @property {string} [currentLineJoin]\r\n * @property {number} [currentLineWidth]\r\n * @property {number} [currentMiterLimit]\r\n * @property {number} [lastStroke]\r\n * @property {module:ol/colorlike~ColorLike} [fillStyle]\r\n * @property {module:ol/colorlike~ColorLike} [strokeStyle]\r\n * @property {string} [lineCap]\r\n * @property {Array.<number>} lineDash\r\n * @property {number} [lineDashOffset]\r\n * @property {string} [lineJoin]\r\n * @property {number} [lineWidth]\r\n * @property {number} [miterLimit]\r\n */\r\n\r\n\r\n/**\r\n * @typedef {Object} StrokeState\r\n * @property {string} lineCap\r\n * @property {Array.<number>} lineDash\r\n * @property {number} lineDashOffset\r\n * @property {string} lineJoin\r\n * @property {number} lineWidth\r\n * @property {number} miterLimit\r\n * @property {module:ol/colorlike~ColorLike} strokeStyle\r\n */\r\n\r\n\r\n/**\r\n * @typedef {Object} TextState\r\n * @property {string} font\r\n * @property {string} [textAlign]\r\n * @property {string} textBaseline\r\n */\r\n\r\n\r\n/**\r\n * Container for decluttered replay instructions that need to be rendered or\r\n * omitted together, i.e. when styles render both an image and text, or for the\r\n * characters that form text along lines. The basic elements of this array are\r\n * `[minX, minY, maxX, maxY, count]`, where the first four entries are the\r\n * rendered extent of the group in pixel space. `count` is the number of styles\r\n * in the group, i.e. 2 when an image and a text are grouped, or 1 otherwise.\r\n * In addition to these four elements, declutter instruction arrays (i.e. the\r\n * arguments to {@link module:ol/render/canvas~drawImage} are appended to the array.\r\n * @typedef {Array.<*>} DeclutterGroup\r\n */\r\n\r\n\r\n/**\r\n * @const\r\n * @type {string}\r\n */\r\nexport const defaultFont = '10px sans-serif';\r\n\r\n\r\n/**\r\n * @const\r\n * @type {module:ol/color~Color}\r\n */\r\nexport const defaultFillStyle = [0, 0, 0, 1];\r\n\r\n\r\n/**\r\n * @const\r\n * @type {string}\r\n */\r\nexport const defaultLineCap = 'round';\r\n\r\n\r\n/**\r\n * @const\r\n * @type {Array.<number>}\r\n */\r\nexport const defaultLineDash = [];\r\n\r\n\r\n/**\r\n * @const\r\n * @type {number}\r\n */\r\nexport const defaultLineDashOffset = 0;\r\n\r\n\r\n/**\r\n * @const\r\n * @type {string}\r\n */\r\nexport const defaultLineJoin = 'round';\r\n\r\n\r\n/**\r\n * @const\r\n * @type {number}\r\n */\r\nexport const defaultMiterLimit = 10;\r\n\r\n\r\n/**\r\n * @const\r\n * @type {module:ol/color~Color}\r\n */\r\nexport const defaultStrokeStyle = [0, 0, 0, 1];\r\n\r\n\r\n/**\r\n * @const\r\n * @type {string}\r\n */\r\nexport const defaultTextAlign = 'center';\r\n\r\n\r\n/**\r\n * @const\r\n * @type {string}\r\n */\r\nexport const defaultTextBaseline = 'middle';\r\n\r\n\r\n/**\r\n * @const\r\n * @type {Array.<number>}\r\n */\r\nexport const defaultPadding = [0, 0, 0, 0];\r\n\r\n\r\n/**\r\n * @const\r\n * @type {number}\r\n */\r\nexport const defaultLineWidth = 1;\r\n\r\n\r\n/**\r\n * The label cache for text rendering. To change the default cache size of 2048\r\n * entries, use {@link module:ol/structs/LRUCache#setSize}.\r\n * @type {module:ol/structs/LRUCache.<HTMLCanvasElement>}\r\n * @api\r\n */\r\nexport const labelCache = new LRUCache();\r\n\r\n\r\n/**\r\n * @type {!Object.<string, number>}\r\n */\r\nexport const checkedFonts = {};\r\n\r\n\r\n/**\r\n * @type {CanvasRenderingContext2D}\r\n */\r\nlet measureContext = null;\r\n\r\n\r\n/**\r\n * @type {!Object.<string, number>}\r\n */\r\nexport const textHeights = {};\r\n\r\n\r\n/**\r\n * Clears the label cache when a font becomes available.\r\n * @param {string} fontSpec CSS font spec.\r\n */\r\nexport const checkFont = (function() {\r\n  const retries = 60;\r\n  const checked = checkedFonts;\r\n  const size = '32px ';\r\n  const referenceFonts = ['monospace', 'serif'];\r\n  const len = referenceFonts.length;\r\n  const text = 'wmytzilWMYTZIL@#/&?$%10\\uF013';\r\n  let interval, referenceWidth;\r\n\r\n  function isAvailable(font) {\r\n    const context = getMeasureContext();\r\n    let available = true;\r\n    for (let i = 0; i < len; ++i) {\r\n      const referenceFont = referenceFonts[i];\r\n      context.font = size + referenceFont;\r\n      referenceWidth = context.measureText(text).width;\r\n      if (font != referenceFont) {\r\n        context.font = size + font + ',' + referenceFont;\r\n        const width = context.measureText(text).width;\r\n        // If width and referenceWidth are the same, then the fallback was used\r\n        // instead of the font we wanted, so the font is not available.\r\n        available = available && width != referenceWidth;\r\n      }\r\n    }\r\n    return available;\r\n  }\r\n\r\n  function check() {\r\n    let done = true;\r\n    for (const font in checked) {\r\n      if (checked[font] < retries) {\r\n        if (isAvailable(font)) {\r\n          checked[font] = retries;\r\n          clear(textHeights);\r\n          // Make sure that loaded fonts are picked up by Safari\r\n          measureContext = null;\r\n          labelCache.clear();\r\n        } else {\r\n          ++checked[font];\r\n          done = false;\r\n        }\r\n      }\r\n    }\r\n    if (done) {\r\n      clearInterval(interval);\r\n      interval = undefined;\r\n    }\r\n  }\r\n\r\n  return function(fontSpec) {\r\n    const fontFamilies = getFontFamilies(fontSpec);\r\n    if (!fontFamilies) {\r\n      return;\r\n    }\r\n    for (let i = 0, ii = fontFamilies.length; i < ii; ++i) {\r\n      const fontFamily = fontFamilies[i];\r\n      if (!(fontFamily in checked)) {\r\n        checked[fontFamily] = retries;\r\n        if (!isAvailable(fontFamily)) {\r\n          checked[fontFamily] = 0;\r\n          if (interval === undefined) {\r\n            interval = setInterval(check, 32);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  };\r\n})();\r\n\r\n\r\n/**\r\n * @return {CanvasRenderingContext2D} Measure context.\r\n */\r\nfunction getMeasureContext() {\r\n  if (!measureContext) {\r\n    measureContext = createCanvasContext2D(1, 1);\r\n  }\r\n  return measureContext;\r\n}\r\n\r\n\r\n/**\r\n * @param {string} font Font to use for measuring.\r\n * @return {module:ol/size~Size} Measurement.\r\n */\r\nexport const measureTextHeight = (function() {\r\n  let span;\r\n  const heights = textHeights;\r\n  return function(font) {\r\n    let height = heights[font];\r\n    if (height == undefined) {\r\n      if (!span) {\r\n        span = document.createElement('span');\r\n        span.textContent = 'M';\r\n        span.style.margin = span.style.padding = '0 !important';\r\n        span.style.position = 'absolute !important';\r\n        span.style.left = '-99999px !important';\r\n      }\r\n      span.style.font = font;\r\n      document.body.appendChild(span);\r\n      height = heights[font] = span.offsetHeight;\r\n      document.body.removeChild(span);\r\n    }\r\n    return height;\r\n  };\r\n})();\r\n\r\n\r\n/**\r\n * @param {string} font Font.\r\n * @param {string} text Text.\r\n * @return {number} Width.\r\n */\r\nexport function measureTextWidth(font, text) {\r\n  const measureContext = getMeasureContext();\r\n  if (font != measureContext.font) {\r\n    measureContext.font = font;\r\n  }\r\n  return measureContext.measureText(text).width;\r\n}\r\n\r\n\r\n/**\r\n * @param {CanvasRenderingContext2D} context Context.\r\n * @param {number} rotation Rotation.\r\n * @param {number} offsetX X offset.\r\n * @param {number} offsetY Y offset.\r\n */\r\nexport function rotateAtOffset(context, rotation, offsetX, offsetY) {\r\n  if (rotation !== 0) {\r\n    context.translate(offsetX, offsetY);\r\n    context.rotate(rotation);\r\n    context.translate(-offsetX, -offsetY);\r\n  }\r\n}\r\n\r\n\r\nexport const resetTransform = createTransform();\r\n\r\n\r\n/**\r\n * @param {CanvasRenderingContext2D} context Context.\r\n * @param {module:ol/transform~Transform|null} transform Transform.\r\n * @param {number} opacity Opacity.\r\n * @param {HTMLImageElement|HTMLCanvasElement|HTMLVideoElement} image Image.\r\n * @param {number} originX Origin X.\r\n * @param {number} originY Origin Y.\r\n * @param {number} w Width.\r\n * @param {number} h Height.\r\n * @param {number} x X.\r\n * @param {number} y Y.\r\n * @param {number} scale Scale.\r\n */\r\nexport function drawImage(context,\r\n  transform, opacity, image, originX, originY, w, h, x, y, scale) {\r\n  let alpha;\r\n  if (opacity != 1) {\r\n    alpha = context.globalAlpha;\r\n    context.globalAlpha = alpha * opacity;\r\n  }\r\n  if (transform) {\r\n    context.setTransform.apply(context, transform);\r\n  }\r\n\r\n  context.drawImage(image, originX, originY, w, h, x, y, w * scale, h * scale);\r\n\r\n  if (alpha) {\r\n    context.globalAlpha = alpha;\r\n  }\r\n  if (transform) {\r\n    context.setTransform.apply(context, resetTransform);\r\n  }\r\n}\r\n"],"names":["const","let"],"mappings":"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"}