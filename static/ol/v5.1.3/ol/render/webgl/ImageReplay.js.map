{"version":3,"file":"ImageReplay.js","sources":["../../../../src/ol/render/webgl/ImageReplay.js"],"sourcesContent":["/**\r\n * @module ol/render/webgl/ImageReplay\r\n */\r\nimport {getUid} from '../../util.js';\r\nimport WebGLTextureReplay from '../webgl/TextureReplay.js';\r\nimport WebGLBuffer from '../../webgl/Buffer.js';\r\n\r\nclass WebGLImageReplay extends WebGLTextureReplay {\r\n  /**\r\n   * @param {number} tolerance Tolerance.\r\n   * @param {module:ol/extent~Extent} maxExtent Max extent.\r\n   */\r\n  constructor(tolerance, maxExtent) {\r\n    super(tolerance, maxExtent);\r\n\r\n    /**\r\n     * @type {Array.<HTMLCanvasElement|HTMLImageElement|HTMLVideoElement>}\r\n     * @protected\r\n     */\r\n    this.images_ = [];\r\n\r\n    /**\r\n     * @type {Array.<HTMLCanvasElement|HTMLImageElement|HTMLVideoElement>}\r\n     * @protected\r\n     */\r\n    this.hitDetectionImages_ = [];\r\n\r\n    /**\r\n     * @type {Array.<WebGLTexture>}\r\n     * @private\r\n     */\r\n    this.textures_ = [];\r\n\r\n    /**\r\n     * @type {Array.<WebGLTexture>}\r\n     * @private\r\n     */\r\n    this.hitDetectionTextures_ = [];\r\n\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  drawMultiPoint(multiPointGeometry, feature) {\r\n    this.startIndices.push(this.indices.length);\r\n    this.startIndicesFeature.push(feature);\r\n    const flatCoordinates = multiPointGeometry.getFlatCoordinates();\r\n    const stride = multiPointGeometry.getStride();\r\n    this.drawCoordinates(\r\n      flatCoordinates, 0, flatCoordinates.length, stride);\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  drawPoint(pointGeometry, feature) {\r\n    this.startIndices.push(this.indices.length);\r\n    this.startIndicesFeature.push(feature);\r\n    const flatCoordinates = pointGeometry.getFlatCoordinates();\r\n    const stride = pointGeometry.getStride();\r\n    this.drawCoordinates(\r\n      flatCoordinates, 0, flatCoordinates.length, stride);\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  finish(context) {\r\n    const gl = context.getGL();\r\n\r\n    this.groupIndices.push(this.indices.length);\r\n    this.hitDetectionGroupIndices.push(this.indices.length);\r\n\r\n    // create, bind, and populate the vertices buffer\r\n    this.verticesBuffer = new WebGLBuffer(this.vertices);\r\n\r\n    const indices = this.indices;\r\n\r\n    // create, bind, and populate the indices buffer\r\n    this.indicesBuffer = new WebGLBuffer(indices);\r\n\r\n    // create textures\r\n    /** @type {Object.<string, WebGLTexture>} */\r\n    const texturePerImage = {};\r\n\r\n    this.createTextures(this.textures_, this.images_, texturePerImage, gl);\r\n\r\n    this.createTextures(this.hitDetectionTextures_, this.hitDetectionImages_,\r\n      texturePerImage, gl);\r\n\r\n    this.images_ = null;\r\n    this.hitDetectionImages_ = null;\r\n    WebGLTextureReplay.prototype.finish.call(this, context);\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  setImageStyle(imageStyle) {\r\n    const anchor = imageStyle.getAnchor();\r\n    const image = imageStyle.getImage(1);\r\n    const imageSize = imageStyle.getImageSize();\r\n    const hitDetectionImage = imageStyle.getHitDetectionImage(1);\r\n    const opacity = imageStyle.getOpacity();\r\n    const origin = imageStyle.getOrigin();\r\n    const rotateWithView = imageStyle.getRotateWithView();\r\n    const rotation = imageStyle.getRotation();\r\n    const size = imageStyle.getSize();\r\n    const scale = imageStyle.getScale();\r\n\r\n    let currentImage;\r\n    if (this.images_.length === 0) {\r\n      this.images_.push(image);\r\n    } else {\r\n      currentImage = this.images_[this.images_.length - 1];\r\n      if (getUid(currentImage) != getUid(image)) {\r\n        this.groupIndices.push(this.indices.length);\r\n        this.images_.push(image);\r\n      }\r\n    }\r\n\r\n    if (this.hitDetectionImages_.length === 0) {\r\n      this.hitDetectionImages_.push(hitDetectionImage);\r\n    } else {\r\n      currentImage =\r\n          this.hitDetectionImages_[this.hitDetectionImages_.length - 1];\r\n      if (getUid(currentImage) != getUid(hitDetectionImage)) {\r\n        this.hitDetectionGroupIndices.push(this.indices.length);\r\n        this.hitDetectionImages_.push(hitDetectionImage);\r\n      }\r\n    }\r\n\r\n    this.anchorX = anchor[0];\r\n    this.anchorY = anchor[1];\r\n    this.height = size[1];\r\n    this.imageHeight = imageSize[1];\r\n    this.imageWidth = imageSize[0];\r\n    this.opacity = opacity;\r\n    this.originX = origin[0];\r\n    this.originY = origin[1];\r\n    this.rotation = rotation;\r\n    this.rotateWithView = rotateWithView;\r\n    this.scale = scale;\r\n    this.width = size[0];\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  getTextures(opt_all) {\r\n    return opt_all ? this.textures_.concat(this.hitDetectionTextures_) : this.textures_;\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  getHitDetectionTextures() {\r\n    return this.hitDetectionTextures_;\r\n  }\r\n}\r\n\r\n\r\nexport default WebGLImageReplay;\r\n"],"names":["super","const","let"],"mappings":"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"}