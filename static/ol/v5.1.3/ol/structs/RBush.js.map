{"version":3,"file":"RBush.js","sources":["../../../src/ol/structs/RBush.js"],"sourcesContent":["/**\r\n * @module ol/structs/RBush\r\n */\r\nimport {getUid} from '../util.js';\r\nimport rbush from 'rbush';\r\nimport {createOrUpdate, equals} from '../extent.js';\r\nimport {isEmpty} from '../obj.js';\r\n\r\n/**\r\n * @typedef {Object} Entry\r\n * @property {number} minX\r\n * @property {number} minY\r\n * @property {number} maxX\r\n * @property {number} maxY\r\n * @property {Object} [value]\r\n */\r\n\r\n/**\r\n * @classdesc\r\n * Wrapper around the RBush by Vladimir Agafonkin.\r\n * See https://github.com/mourner/rbush.\r\n *\r\n * @template T\r\n */\r\nclass RBush {\r\n  /**\r\n   * @param {number=} opt_maxEntries Max entries.\r\n   */\r\n  constructor(opt_maxEntries) {\r\n\r\n    /**\r\n     * @private\r\n     */\r\n    this.rbush_ = rbush(opt_maxEntries, undefined);\r\n\r\n    /**\r\n     * A mapping between the objects added to this rbush wrapper\r\n     * and the objects that are actually added to the internal rbush.\r\n     * @private\r\n     * @type {Object.<number, module:ol/structs/RBush~Entry>}\r\n     */\r\n    this.items_ = {};\r\n\r\n  }\r\n\r\n  /**\r\n   * Insert a value into the RBush.\r\n   * @param {module:ol/extent~Extent} extent Extent.\r\n   * @param {T} value Value.\r\n   */\r\n  insert(extent, value) {\r\n    /** @type {module:ol/structs/RBush~Entry} */\r\n    const item = {\r\n      minX: extent[0],\r\n      minY: extent[1],\r\n      maxX: extent[2],\r\n      maxY: extent[3],\r\n      value: value\r\n    };\r\n\r\n    this.rbush_.insert(item);\r\n    this.items_[getUid(value)] = item;\r\n  }\r\n\r\n\r\n  /**\r\n   * Bulk-insert values into the RBush.\r\n   * @param {Array.<module:ol/extent~Extent>} extents Extents.\r\n   * @param {Array.<T>} values Values.\r\n   */\r\n  load(extents, values) {\r\n    const items = new Array(values.length);\r\n    for (let i = 0, l = values.length; i < l; i++) {\r\n      const extent = extents[i];\r\n      const value = values[i];\r\n\r\n      /** @type {module:ol/structs/RBush~Entry} */\r\n      const item = {\r\n        minX: extent[0],\r\n        minY: extent[1],\r\n        maxX: extent[2],\r\n        maxY: extent[3],\r\n        value: value\r\n      };\r\n      items[i] = item;\r\n      this.items_[getUid(value)] = item;\r\n    }\r\n    this.rbush_.load(items);\r\n  }\r\n\r\n\r\n  /**\r\n   * Remove a value from the RBush.\r\n   * @param {T} value Value.\r\n   * @return {boolean} Removed.\r\n   */\r\n  remove(value) {\r\n    const uid = getUid(value);\r\n\r\n    // get the object in which the value was wrapped when adding to the\r\n    // internal rbush. then use that object to do the removal.\r\n    const item = this.items_[uid];\r\n    delete this.items_[uid];\r\n    return this.rbush_.remove(item) !== null;\r\n  }\r\n\r\n\r\n  /**\r\n   * Update the extent of a value in the RBush.\r\n   * @param {module:ol/extent~Extent} extent Extent.\r\n   * @param {T} value Value.\r\n   */\r\n  update(extent, value) {\r\n    const item = this.items_[getUid(value)];\r\n    const bbox = [item.minX, item.minY, item.maxX, item.maxY];\r\n    if (!equals(bbox, extent)) {\r\n      this.remove(value);\r\n      this.insert(extent, value);\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Return all values in the RBush.\r\n   * @return {Array.<T>} All.\r\n   */\r\n  getAll() {\r\n    const items = this.rbush_.all();\r\n    return items.map(function(item) {\r\n      return item.value;\r\n    });\r\n  }\r\n\r\n\r\n  /**\r\n   * Return all values in the given extent.\r\n   * @param {module:ol/extent~Extent} extent Extent.\r\n   * @return {Array.<T>} All in extent.\r\n   */\r\n  getInExtent(extent) {\r\n    /** @type {module:ol/structs/RBush~Entry} */\r\n    const bbox = {\r\n      minX: extent[0],\r\n      minY: extent[1],\r\n      maxX: extent[2],\r\n      maxY: extent[3]\r\n    };\r\n    const items = this.rbush_.search(bbox);\r\n    return items.map(function(item) {\r\n      return item.value;\r\n    });\r\n  }\r\n\r\n\r\n  /**\r\n   * Calls a callback function with each value in the tree.\r\n   * If the callback returns a truthy value, this value is returned without\r\n   * checking the rest of the tree.\r\n   * @param {function(this: S, T): *} callback Callback.\r\n   * @param {S=} opt_this The object to use as `this` in `callback`.\r\n   * @return {*} Callback return value.\r\n   * @template S\r\n   */\r\n  forEach(callback, opt_this) {\r\n    return this.forEach_(this.getAll(), callback, opt_this);\r\n  }\r\n\r\n\r\n  /**\r\n   * Calls a callback function with each value in the provided extent.\r\n   * @param {module:ol/extent~Extent} extent Extent.\r\n   * @param {function(this: S, T): *} callback Callback.\r\n   * @param {S=} opt_this The object to use as `this` in `callback`.\r\n   * @return {*} Callback return value.\r\n   * @template S\r\n   */\r\n  forEachInExtent(extent, callback, opt_this) {\r\n    return this.forEach_(this.getInExtent(extent), callback, opt_this);\r\n  }\r\n\r\n\r\n  /**\r\n   * @param {Array.<T>} values Values.\r\n   * @param {function(this: S, T): *} callback Callback.\r\n   * @param {S=} opt_this The object to use as `this` in `callback`.\r\n   * @private\r\n   * @return {*} Callback return value.\r\n   * @template S\r\n   */\r\n  forEach_(values, callback, opt_this) {\r\n    let result;\r\n    for (let i = 0, l = values.length; i < l; i++) {\r\n      result = callback.call(opt_this, values[i]);\r\n      if (result) {\r\n        return result;\r\n      }\r\n    }\r\n    return result;\r\n  }\r\n\r\n\r\n  /**\r\n   * @return {boolean} Is empty.\r\n   */\r\n  isEmpty() {\r\n    return isEmpty(this.items_);\r\n  }\r\n\r\n\r\n  /**\r\n   * Remove all values from the RBush.\r\n   */\r\n  clear() {\r\n    this.rbush_.clear();\r\n    this.items_ = {};\r\n  }\r\n\r\n\r\n  /**\r\n   * @param {module:ol/extent~Extent=} opt_extent Extent.\r\n   * @return {module:ol/extent~Extent} Extent.\r\n   */\r\n  getExtent(opt_extent) {\r\n    // FIXME add getExtent() to rbush\r\n    const data = this.rbush_.data;\r\n    return createOrUpdate(data.minX, data.minY, data.maxX, data.maxY, opt_extent);\r\n  }\r\n\r\n\r\n  /**\r\n   * @param {module:ol/structs/RBush} rbush R-Tree.\r\n   */\r\n  concat(rbush) {\r\n    this.rbush_.load(rbush.rbush_.all());\r\n    for (const i in rbush.items_) {\r\n      this.items_[i | 0] = rbush.items_[i | 0];\r\n    }\r\n  }\r\n\r\n}\r\n\r\n\r\nexport default RBush;\r\n"],"names":["const","let","this"],"mappings":"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"}