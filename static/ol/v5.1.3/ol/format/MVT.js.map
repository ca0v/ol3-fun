{"version":3,"file":"MVT.js","sources":["../../../src/ol/format/MVT.js"],"sourcesContent":["/**\r\n * @module ol/format/MVT\r\n */\r\n//FIXME Implement projection handling\r\n\r\nimport {assert} from '../asserts.js';\r\nimport PBF from 'pbf';\r\nimport FeatureFormat, {transformWithOptions} from '../format/Feature.js';\r\nimport FormatType from '../format/FormatType.js';\r\nimport GeometryLayout from '../geom/GeometryLayout.js';\r\nimport GeometryType from '../geom/GeometryType.js';\r\nimport LineString from '../geom/LineString.js';\r\nimport MultiLineString from '../geom/MultiLineString.js';\r\nimport MultiPoint from '../geom/MultiPoint.js';\r\nimport MultiPolygon from '../geom/MultiPolygon.js';\r\nimport Point from '../geom/Point.js';\r\nimport Polygon from '../geom/Polygon.js';\r\nimport {linearRingIsClockwise} from '../geom/flat/orient.js';\r\nimport Projection from '../proj/Projection.js';\r\nimport Units from '../proj/Units.js';\r\nimport RenderFeature from '../render/Feature.js';\r\n\r\n\r\n/**\r\n * @typedef {Object} Options\r\n * @property {function((module:ol/geom/Geometry|Object.<string,*>)=)|function(module:ol/geom/GeometryType,Array.<number>,(Array.<number>|Array.<Array.<number>>),Object.<string,*>,number)} [featureClass]\r\n * Class for features returned by {@link module:ol/format/MVT#readFeatures}. Set to\r\n * {@link module:ol/Feature~Feature} to get full editing and geometry support at the cost of\r\n * decreased rendering performance. The default is {@link module:ol/render/Feature~RenderFeature},\r\n * which is optimized for rendering and hit detection.\r\n * @property {string} [geometryName='geometry'] Geometry name to use when creating\r\n * features.\r\n * @property {string} [layerName='layer'] Name of the feature attribute that\r\n * holds the layer name.\r\n * @property {Array.<string>} [layers] Layers to read features from. If not\r\n * provided, features will be read from all layers.\r\n */\r\n\r\n\r\n/**\r\n * @classdesc\r\n * Feature format for reading data in the Mapbox MVT format.\r\n *\r\n * @param {module:ol/format/MVT~Options=} opt_options Options.\r\n * @api\r\n */\r\nclass MVT extends FeatureFormat {\r\n\r\n  /**\r\n   * @param {module:ol/format/MVT~Options=} opt_options Options.\r\n   */\r\n  constructor(opt_options) {\r\n    super();\r\n\r\n    const options = opt_options ? opt_options : {};\r\n\r\n    /**\r\n     * @type {module:ol/proj/Projection}\r\n     */\r\n    this.dataProjection = new Projection({\r\n      code: '',\r\n      units: Units.TILE_PIXELS\r\n    });\r\n\r\n    /**\r\n     * @private\r\n     * @type {function((module:ol/geom/Geometry|Object.<string,*>)=)|\r\n     *     function(module:ol/geom/GeometryType,Array.<number>,\r\n     *         (Array.<number>|Array.<Array.<number>>),Object.<string,*>,number)}\r\n     */\r\n    this.featureClass_ = options.featureClass ?\r\n      options.featureClass : RenderFeature;\r\n\r\n    /**\r\n     * @private\r\n     * @type {string|undefined}\r\n     */\r\n    this.geometryName_ = options.geometryName;\r\n\r\n    /**\r\n     * @private\r\n     * @type {string}\r\n     */\r\n    this.layerName_ = options.layerName ? options.layerName : 'layer';\r\n\r\n    /**\r\n     * @private\r\n     * @type {Array.<string>}\r\n     */\r\n    this.layers_ = options.layers ? options.layers : null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/extent~Extent}\r\n     */\r\n    this.extent_ = null;\r\n\r\n  }\r\n\r\n  /**\r\n   * Read the raw geometry from the pbf offset stored in a raw feature's geometry\r\n   * property.\r\n   * @suppress {missingProperties}\r\n   * @param {Object} pbf PBF.\r\n   * @param {Object} feature Raw feature.\r\n   * @param {Array.<number>} flatCoordinates Array to store flat coordinates in.\r\n   * @param {Array.<number>} ends Array to store ends in.\r\n   * @private\r\n   */\r\n  readRawGeometry_(pbf, feature, flatCoordinates, ends) {\r\n    pbf.pos = feature.geometry;\r\n\r\n    const end = pbf.readVarint() + pbf.pos;\r\n    let cmd = 1;\r\n    let length = 0;\r\n    let x = 0;\r\n    let y = 0;\r\n    let coordsLen = 0;\r\n    let currentEnd = 0;\r\n\r\n    while (pbf.pos < end) {\r\n      if (!length) {\r\n        const cmdLen = pbf.readVarint();\r\n        cmd = cmdLen & 0x7;\r\n        length = cmdLen >> 3;\r\n      }\r\n\r\n      length--;\r\n\r\n      if (cmd === 1 || cmd === 2) {\r\n        x += pbf.readSVarint();\r\n        y += pbf.readSVarint();\r\n\r\n        if (cmd === 1) { // moveTo\r\n          if (coordsLen > currentEnd) {\r\n            ends.push(coordsLen);\r\n            currentEnd = coordsLen;\r\n          }\r\n        }\r\n\r\n        flatCoordinates.push(x, y);\r\n        coordsLen += 2;\r\n\r\n      } else if (cmd === 7) {\r\n\r\n        if (coordsLen > currentEnd) {\r\n          // close polygon\r\n          flatCoordinates.push(\r\n            flatCoordinates[currentEnd], flatCoordinates[currentEnd + 1]);\r\n          coordsLen += 2;\r\n        }\r\n\r\n      } else {\r\n        assert(false, 59); // Invalid command found in the PBF\r\n      }\r\n    }\r\n\r\n    if (coordsLen > currentEnd) {\r\n      ends.push(coordsLen);\r\n      currentEnd = coordsLen;\r\n    }\r\n\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   * @param {Object} pbf PBF\r\n   * @param {Object} rawFeature Raw Mapbox feature.\r\n   * @param {module:ol/format/Feature~ReadOptions=} opt_options Read options.\r\n   * @return {module:ol/Feature|module:ol/render/Feature} Feature.\r\n   */\r\n  createFeature_(pbf, rawFeature, opt_options) {\r\n    const type = rawFeature.type;\r\n    if (type === 0) {\r\n      return null;\r\n    }\r\n\r\n    let feature;\r\n    const id = rawFeature.id;\r\n    const values = rawFeature.properties;\r\n    values[this.layerName_] = rawFeature.layer.name;\r\n\r\n    const flatCoordinates = [];\r\n    const ends = [];\r\n    this.readRawGeometry_(pbf, rawFeature, flatCoordinates, ends);\r\n\r\n    const geometryType = getGeometryType(type, ends.length);\r\n\r\n    if (this.featureClass_ === RenderFeature) {\r\n      feature = new this.featureClass_(geometryType, flatCoordinates, ends, values, id);\r\n    } else {\r\n      let geom;\r\n      if (geometryType == GeometryType.POLYGON) {\r\n        const endss = [];\r\n        let offset = 0;\r\n        let prevEndIndex = 0;\r\n        for (let i = 0, ii = ends.length; i < ii; ++i) {\r\n          const end = ends[i];\r\n          if (!linearRingIsClockwise(flatCoordinates, offset, end, 2)) {\r\n            endss.push(ends.slice(prevEndIndex, i));\r\n            prevEndIndex = i;\r\n          }\r\n          offset = end;\r\n        }\r\n        if (endss.length > 1) {\r\n          geom = new MultiPolygon(flatCoordinates, GeometryLayout.XY, endss);\r\n        } else {\r\n          geom = new Polygon(flatCoordinates, GeometryLayout.XY, ends);\r\n        }\r\n      } else {\r\n        geom = geometryType === GeometryType.POINT ? new Point(flatCoordinates, GeometryLayout.XY) :\r\n          geometryType === GeometryType.LINE_STRING ? new LineString(flatCoordinates, GeometryLayout.XY) :\r\n            geometryType === GeometryType.POLYGON ? new Polygon(flatCoordinates, GeometryLayout.XY, ends) :\r\n              geometryType === GeometryType.MULTI_POINT ? new MultiPoint(flatCoordinates, GeometryLayout.XY) :\r\n                geometryType === GeometryType.MULTI_LINE_STRING ? new MultiLineString(flatCoordinates, GeometryLayout.XY, ends) :\r\n                  null;\r\n      }\r\n      feature = new this.featureClass_();\r\n      if (this.geometryName_) {\r\n        feature.setGeometryName(this.geometryName_);\r\n      }\r\n      const geometry = transformWithOptions(geom, false, this.adaptOptions(opt_options));\r\n      feature.setGeometry(geometry);\r\n      feature.setId(id);\r\n      feature.setProperties(values);\r\n    }\r\n\r\n    return feature;\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   * @api\r\n   */\r\n  getLastExtent() {\r\n    return this.extent_;\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  getType() {\r\n    return FormatType.ARRAY_BUFFER;\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   * @api\r\n   */\r\n  readFeatures(source, opt_options) {\r\n    const layers = this.layers_;\r\n\r\n    const pbf = new PBF(/** @type {ArrayBuffer} */ (source));\r\n    const pbfLayers = pbf.readFields(layersPBFReader, {});\r\n    /** @type {Array.<module:ol/Feature|module:ol/render/Feature>} */\r\n    const features = [];\r\n    for (const name in pbfLayers) {\r\n      if (layers && layers.indexOf(name) == -1) {\r\n        continue;\r\n      }\r\n      const pbfLayer = pbfLayers[name];\r\n\r\n      for (let i = 0, ii = pbfLayer.length; i < ii; ++i) {\r\n        const rawFeature = readRawFeature(pbf, pbfLayer, i);\r\n        features.push(this.createFeature_(pbf, rawFeature));\r\n      }\r\n      this.extent_ = pbfLayer ? [0, 0, pbfLayer.extent, pbfLayer.extent] : null;\r\n    }\r\n\r\n    return features;\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   * @api\r\n   */\r\n  readProjection(source) {\r\n    return this.dataProjection;\r\n  }\r\n\r\n  /**\r\n   * Sets the layers that features will be read from.\r\n   * @param {Array.<string>} layers Layers.\r\n   * @api\r\n   */\r\n  setLayers(layers) {\r\n    this.layers_ = layers;\r\n  }\r\n\r\n  /**\r\n   * Not implemented.\r\n   * @override\r\n   */\r\n  readFeature() {}\r\n\r\n  /**\r\n   * Not implemented.\r\n   * @override\r\n   */\r\n  readGeometry() {}\r\n\r\n  /**\r\n   * Not implemented.\r\n   * @override\r\n   */\r\n  writeFeature() {}\r\n\r\n  /**\r\n   * Not implemented.\r\n   * @override\r\n   */\r\n  writeGeometry() {}\r\n\r\n  /**\r\n   * Not implemented.\r\n   * @override\r\n   */\r\n  writeFeatures() {}\r\n}\r\n\r\n\r\n/**\r\n * Reader callback for parsing layers.\r\n * @param {number} tag The tag.\r\n * @param {Object} layers The layers object.\r\n * @param {Object} pbf The PBF.\r\n */\r\nfunction layersPBFReader(tag, layers, pbf) {\r\n  if (tag === 3) {\r\n    const layer = {\r\n      keys: [],\r\n      values: [],\r\n      features: []\r\n    };\r\n    const end = pbf.readVarint() + pbf.pos;\r\n    pbf.readFields(layerPBFReader, layer, end);\r\n    layer.length = layer.features.length;\r\n    if (layer.length) {\r\n      layers[layer.name] = layer;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Reader callback for parsing layer.\r\n * @param {number} tag The tag.\r\n * @param {Object} layer The layer object.\r\n * @param {Object} pbf The PBF.\r\n */\r\nfunction layerPBFReader(tag, layer, pbf) {\r\n  if (tag === 15) {\r\n    layer.version = pbf.readVarint();\r\n  } else if (tag === 1) {\r\n    layer.name = pbf.readString();\r\n  } else if (tag === 5) {\r\n    layer.extent = pbf.readVarint();\r\n  } else if (tag === 2) {\r\n    layer.features.push(pbf.pos);\r\n  } else if (tag === 3) {\r\n    layer.keys.push(pbf.readString());\r\n  } else if (tag === 4) {\r\n    let value = null;\r\n    const end = pbf.readVarint() + pbf.pos;\r\n    while (pbf.pos < end) {\r\n      tag = pbf.readVarint() >> 3;\r\n      value = tag === 1 ? pbf.readString() :\r\n        tag === 2 ? pbf.readFloat() :\r\n          tag === 3 ? pbf.readDouble() :\r\n            tag === 4 ? pbf.readVarint64() :\r\n              tag === 5 ? pbf.readVarint() :\r\n                tag === 6 ? pbf.readSVarint() :\r\n                  tag === 7 ? pbf.readBoolean() : null;\r\n    }\r\n    layer.values.push(value);\r\n  }\r\n}\r\n\r\n/**\r\n * Reader callback for parsing feature.\r\n * @param {number} tag The tag.\r\n * @param {Object} feature The feature object.\r\n * @param {Object} pbf The PBF.\r\n */\r\nfunction featurePBFReader(tag, feature, pbf) {\r\n  if (tag == 1) {\r\n    feature.id = pbf.readVarint();\r\n  } else if (tag == 2) {\r\n    const end = pbf.readVarint() + pbf.pos;\r\n    while (pbf.pos < end) {\r\n      const key = feature.layer.keys[pbf.readVarint()];\r\n      const value = feature.layer.values[pbf.readVarint()];\r\n      feature.properties[key] = value;\r\n    }\r\n  } else if (tag == 3) {\r\n    feature.type = pbf.readVarint();\r\n  } else if (tag == 4) {\r\n    feature.geometry = pbf.pos;\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * Read a raw feature from the pbf offset stored at index `i` in the raw layer.\r\n * @suppress {missingProperties}\r\n * @param {Object} pbf PBF.\r\n * @param {Object} layer Raw layer.\r\n * @param {number} i Index of the feature in the raw layer's `features` array.\r\n * @return {Object} Raw feature.\r\n */\r\nfunction readRawFeature(pbf, layer, i) {\r\n  pbf.pos = layer.features[i];\r\n  const end = pbf.readVarint() + pbf.pos;\r\n\r\n  const feature = {\r\n    layer: layer,\r\n    type: 0,\r\n    properties: {}\r\n  };\r\n  pbf.readFields(featurePBFReader, feature, end);\r\n  return feature;\r\n}\r\n\r\n\r\n/**\r\n * @suppress {missingProperties}\r\n * @param {number} type The raw feature's geometry type\r\n * @param {number} numEnds Number of ends of the flat coordinates of the\r\n * geometry.\r\n * @return {module:ol/geom/GeometryType} The geometry type.\r\n */\r\nfunction getGeometryType(type, numEnds) {\r\n  /** @type {module:ol/geom/GeometryType} */\r\n  let geometryType;\r\n  if (type === 1) {\r\n    geometryType = numEnds === 1 ?\r\n      GeometryType.POINT : GeometryType.MULTI_POINT;\r\n  } else if (type === 2) {\r\n    geometryType = numEnds === 1 ?\r\n      GeometryType.LINE_STRING :\r\n      GeometryType.MULTI_LINE_STRING;\r\n  } else if (type === 3) {\r\n    geometryType = GeometryType.POLYGON;\r\n    // MultiPolygon not relevant for rendering - winding order determines\r\n    // outer rings of polygons.\r\n  }\r\n  return geometryType;\r\n}\r\n\r\nexport default MVT;\r\n"],"names":["super","const","let","this"],"mappings":"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"}