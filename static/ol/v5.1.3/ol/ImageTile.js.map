{"version":3,"file":"ImageTile.js","sources":["../../src/ol/ImageTile.js"],"sourcesContent":["/**\r\n * @module ol/ImageTile\r\n */\r\nimport Tile from './Tile.js';\r\nimport TileState from './TileState.js';\r\nimport {createCanvasContext2D} from './dom.js';\r\nimport {listenOnce, unlistenByKey} from './events.js';\r\nimport EventType from './events/EventType.js';\r\n\r\n/**\r\n * @typedef {function(new: module:ol/ImageTile, module:ol/tilecoord~TileCoord,\r\n * module:ol/TileState, string, ?string, module:ol/Tile~LoadFunction)} TileClass\r\n * @api\r\n */\r\n\r\nclass ImageTile extends Tile {\r\n\r\n  /**\r\n   * @param {module:ol/tilecoord~TileCoord} tileCoord Tile coordinate.\r\n   * @param {module:ol/TileState} state State.\r\n   * @param {string} src Image source URI.\r\n   * @param {?string} crossOrigin Cross origin.\r\n   * @param {module:ol/Tile~LoadFunction} tileLoadFunction Tile load function.\r\n   * @param {module:ol/Tile~Options=} opt_options Tile options.\r\n   */\r\n  constructor(tileCoord, state, src, crossOrigin, tileLoadFunction, opt_options) {\r\n\r\n    super(tileCoord, state, opt_options);\r\n\r\n    /**\r\n     * @private\r\n     * @type {?string}\r\n     */\r\n    this.crossOrigin_ = crossOrigin;\r\n\r\n    /**\r\n     * Image URI\r\n     *\r\n     * @private\r\n     * @type {string}\r\n     */\r\n    this.src_ = src;\r\n\r\n    /**\r\n     * @private\r\n     * @type {HTMLImageElement|HTMLCanvasElement}\r\n     */\r\n    this.image_ = new Image();\r\n    if (crossOrigin !== null) {\r\n      this.image_.crossOrigin = crossOrigin;\r\n    }\r\n\r\n    /**\r\n     * @private\r\n     * @type {Array.<module:ol/events~EventsKey>}\r\n     */\r\n    this.imageListenerKeys_ = null;\r\n\r\n    /**\r\n     * @private\r\n     * @type {module:ol/Tile~LoadFunction}\r\n     */\r\n    this.tileLoadFunction_ = tileLoadFunction;\r\n\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  disposeInternal() {\r\n    if (this.state == TileState.LOADING) {\r\n      this.unlistenImage_();\r\n      this.image_ = getBlankImage();\r\n    }\r\n    if (this.interimTile) {\r\n      this.interimTile.dispose();\r\n    }\r\n    this.state = TileState.ABORT;\r\n    this.changed();\r\n    super.disposeInternal();\r\n  }\r\n\r\n  /**\r\n   * Get the HTML image element for this tile (may be a Canvas, Image, or Video).\r\n   * @return {HTMLCanvasElement|HTMLImageElement|HTMLVideoElement} Image.\r\n   * @api\r\n   */\r\n  getImage() {\r\n    return this.image_;\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   */\r\n  getKey() {\r\n    return this.src_;\r\n  }\r\n\r\n  /**\r\n   * Tracks loading or read errors.\r\n   *\r\n   * @private\r\n   */\r\n  handleImageError_() {\r\n    this.state = TileState.ERROR;\r\n    this.unlistenImage_();\r\n    this.image_ = getBlankImage();\r\n    this.changed();\r\n  }\r\n\r\n  /**\r\n   * Tracks successful image load.\r\n   *\r\n   * @private\r\n   */\r\n  handleImageLoad_() {\r\n    if (this.image_.naturalWidth && this.image_.naturalHeight) {\r\n      this.state = TileState.LOADED;\r\n    } else {\r\n      this.state = TileState.EMPTY;\r\n    }\r\n    this.unlistenImage_();\r\n    this.changed();\r\n  }\r\n\r\n  /**\r\n   * @inheritDoc\r\n   * @api\r\n   */\r\n  load() {\r\n    if (this.state == TileState.ERROR) {\r\n      this.state = TileState.IDLE;\r\n      this.image_ = new Image();\r\n      if (this.crossOrigin_ !== null) {\r\n        this.image_.crossOrigin = this.crossOrigin_;\r\n      }\r\n    }\r\n    if (this.state == TileState.IDLE) {\r\n      this.state = TileState.LOADING;\r\n      this.changed();\r\n      this.imageListenerKeys_ = [\r\n        listenOnce(this.image_, EventType.ERROR,\r\n          this.handleImageError_, this),\r\n        listenOnce(this.image_, EventType.LOAD,\r\n          this.handleImageLoad_, this)\r\n      ];\r\n      this.tileLoadFunction_(this, this.src_);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Discards event handlers which listen for load completion or errors.\r\n   *\r\n   * @private\r\n   */\r\n  unlistenImage_() {\r\n    this.imageListenerKeys_.forEach(unlistenByKey);\r\n    this.imageListenerKeys_ = null;\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * Get a 1-pixel blank image.\r\n * @return {HTMLCanvasElement} Blank image.\r\n */\r\nfunction getBlankImage() {\r\n  const ctx = createCanvasContext2D(1, 1);\r\n  ctx.fillStyle = 'rgba(0,0,0,0)';\r\n  ctx.fillRect(0, 0, 1, 1);\r\n  return ctx.canvas;\r\n}\r\n\r\nexport default ImageTile;\r\n"],"names":["super","const"],"mappings":"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"}